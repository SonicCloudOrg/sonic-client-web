{"version":3,"file":"InvalidationsHandler.test.js","sourceRoot":"","sources":["../../../../../../../front_end/models/trace/handlers/InvalidationsHandler.test.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2023 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport type * as Protocol from '../../../generated/protocol.js';\nimport {TraceLoader} from '../../../testing/TraceLoader.js';\nimport * as TraceEngine from '../trace.js';\n\nfunction invalidationDataForTestAssertion(invalidation: TraceEngine.Types.TraceEvents.SyntheticInvalidation): {\n  nodeId: Protocol.DOM.BackendNodeId,\n  nodeName?: string,\n  reason?: string,\n  stackTrace?: TraceEngine.Types.TraceEvents.TraceEventCallFrame[],\n} {\n  return {\n    nodeId: invalidation.nodeId,\n    nodeName: invalidation.nodeName,\n    reason: invalidation.reason,\n    stackTrace: invalidation.stackTrace,\n  };\n}\n\ndescribe('InvalidationsHandler', () => {\n  beforeEach(() => {\n    TraceEngine.Handlers.ModelHandlers.Invalidations.reset();\n    TraceEngine.Handlers.ModelHandlers.Invalidations.initialize();\n  });\n\n  it('finds the right invalidators for a layout where attributes have been changed', async function() {\n    const events = await TraceLoader.rawEvents(this, 'style-invalidation-change-attribute.json.gz');\n\n    for (const event of events) {\n      TraceEngine.Handlers.ModelHandlers.Invalidations.handleEvent(event);\n    }\n    await TraceEngine.Handlers.ModelHandlers.Invalidations.finalize();\n    const data = TraceEngine.Handlers.ModelHandlers.Invalidations.data();\n    // Find the Layout event that we want to test - we are testing\n    // the layout that happens after button click that happened in\n    // the trace.\n    const updateLayoutTreeEvent = events.find(event => {\n      return TraceEngine.Types.TraceEvents.isTraceEventUpdateLayoutTree(event) &&\n          event.args.beginData?.stackTrace?.[0].functionName === 'testFuncs.changeAttributeAndDisplay';\n    });\n    if (!updateLayoutTreeEvent) {\n      throw new Error('Could not find UpdateLayoutTree event.');\n    }\n\n    const invalidations =\n        data.invalidationsForEvent.get(updateLayoutTreeEvent)?.map(invalidationDataForTestAssertion) ?? [];\n\n    assert.deepEqual(invalidations, [\n      {\n        nodeId: 107 as Protocol.DOM.BackendNodeId,\n        nodeName: 'BUTTON id=\\'changeAttributeAndDisplay\\'',\n        reason: 'PseudoClass',\n        stackTrace: undefined,\n      },\n      {\n        nodeId: 110 as Protocol.DOM.BackendNodeId,\n        nodeName: 'DIV id=\\'testElementFour\\'',\n        reason: undefined,\n        stackTrace: [\n          {\n            columnNumber: 46,\n            functionName: 'testFuncs.changeAttributeAndDisplay',\n            lineNumber: 45,\n            scriptId: '86',\n            url: 'https://chromedevtools.github.io/performance-stories/style-invalidations/app.js',\n          },\n        ],\n      },\n      {\n        nodeId: 110 as Protocol.DOM.BackendNodeId,\n        nodeName: 'DIV id=\\'testElementFour\\'',\n        reason: 'StyleInvalidator',\n        stackTrace: [\n          {\n            columnNumber: 46,\n            functionName: 'testFuncs.changeAttributeAndDisplay',\n            lineNumber: 45,\n            scriptId: '86',\n            url: 'https://chromedevtools.github.io/performance-stories/style-invalidations/app.js',\n          },\n        ],\n      },\n      {\n        nodeId: 110 as Protocol.DOM.BackendNodeId,\n        nodeName: 'DIV id=\\'testElementFour\\'',\n        reason: 'Attribute',\n        stackTrace: [\n          {\n            columnNumber: 46,\n            functionName: 'testFuncs.changeAttributeAndDisplay',\n            lineNumber: 45,\n            scriptId: '86',\n            url: 'https://chromedevtools.github.io/performance-stories/style-invalidations/app.js',\n          },\n        ],\n      },\n      {\n        nodeId: 111 as Protocol.DOM.BackendNodeId,\n        nodeName: 'DIV id=\\'testElementFive\\'',\n        reason: undefined,\n        stackTrace: [\n          {\n            columnNumber: 46,\n            functionName: 'testFuncs.changeAttributeAndDisplay',\n            lineNumber: 46,\n            scriptId: '86',\n            url: 'https://chromedevtools.github.io/performance-stories/style-invalidations/app.js',\n          },\n        ],\n      },\n      {\n        nodeId: 111 as Protocol.DOM.BackendNodeId,\n        nodeName: 'DIV id=\\'testElementFive\\'',\n        reason: 'StyleInvalidator',\n        stackTrace: [\n          {\n            columnNumber: 46,\n            functionName: 'testFuncs.changeAttributeAndDisplay',\n            lineNumber: 46,\n            scriptId: '86',\n            url: 'https://chromedevtools.github.io/performance-stories/style-invalidations/app.js',\n          },\n        ],\n      },\n      {\n        nodeId: 111 as Protocol.DOM.BackendNodeId,\n        nodeName: 'DIV id=\\'testElementFive\\'',\n        reason: 'Attribute',\n        stackTrace: [\n          {\n            columnNumber: 46,\n            functionName: 'testFuncs.changeAttributeAndDisplay',\n            lineNumber: 46,\n            scriptId: '86',\n            url: 'https://chromedevtools.github.io/performance-stories/style-invalidations/app.js',\n          },\n        ],\n      },\n      {\n        nodeId: 110 as Protocol.DOM.BackendNodeId,\n        nodeName: 'DIV id=\\'testElementFour\\'',\n        reason: 'Element has pending invalidation list',\n        stackTrace: undefined,\n      },\n      {\n        nodeId: 111 as Protocol.DOM.BackendNodeId,\n        nodeName: 'DIV id=\\'testElementFive\\'',\n        reason: 'Element has pending invalidation list',\n        stackTrace: undefined,\n      },\n    ]);\n  });\n});\n"]}