{"version":3,"file":"PuppeteerConnection.js","sourceRoot":"","sources":["../../../../../../front_end/services/puppeteer/PuppeteerConnection.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) 2022 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as puppeteer from '../../third_party/puppeteer/puppeteer.js';\nimport type * as Protocol from '../../generated/protocol.js';\nimport type * as SDK from '../../core/sdk/sdk.js';\n\nclass Transport implements puppeteer.ConnectionTransport {\n  #connection: SDK.Connections.ParallelConnectionInterface;\n\n  constructor(connection: SDK.Connections.ParallelConnectionInterface) {\n    this.#connection = connection;\n  }\n\n  send(data: string): void {\n    this.#connection.sendRawMessage(data);\n  }\n\n  close(): void {\n    void this.#connection.disconnect();\n  }\n\n  set onmessage(cb: (message: string) => void) {\n    this.#connection.setOnMessage((message: Object) => {\n      const data = (message) as {id: number, method: string, params: unknown, sessionId?: string};\n      if (!data.sessionId) {\n        return;\n      }\n\n      return cb(JSON.stringify({\n        ...data,\n        // Puppeteer is expecting to use the default session, but we give it a non-default session in #connection.\n        // Replace that sessionId with undefined so Puppeteer treats it as default.\n        sessionId: data.sessionId === this.#connection.getSessionId() ? undefined : data.sessionId,\n      }));\n    });\n  }\n\n  set onclose(cb: () => void) {\n    const prev = this.#connection.getOnDisconnect();\n    this.#connection.setOnDisconnect(reason => {\n      if (prev) {\n        prev(reason);\n      }\n      if (cb) {\n        cb();\n      }\n    });\n  }\n}\n\nclass PuppeteerConnection extends puppeteer.Connection {\n  override async onMessage(message: string): Promise<void> {\n    const msgObj = JSON.parse(message) as {id: number, method: string, params: unknown, sessionId?: string};\n    if (msgObj.sessionId && !this._sessions.has(msgObj.sessionId)) {\n      return;\n    }\n    void super.onMessage(message);\n  }\n}\n\nexport class PuppeteerConnectionHelper {\n  static async connectPuppeteerToConnectionViaTab(options: {\n    connection: SDK.Connections.ParallelConnectionInterface,\n    rootTargetId: string,\n    isPageTargetCallback: (targetInfo: Protocol.Target.TargetInfo) => boolean,\n  }): Promise<{\n    page: puppeteer.Page | null,\n    browser: puppeteer.Browser,\n    puppeteerConnection: puppeteer.Connection,\n  }> {\n    const {connection, rootTargetId, isPageTargetCallback} = options;\n    // Pass an empty message handler because it will be overwritten by puppeteer anyways.\n    const transport = new Transport(connection);\n\n    // url is an empty string in this case parallel to:\n    // https://github.com/puppeteer/puppeteer/blob/f63a123ecef86693e6457b07437a96f108f3e3c5/src/common/BrowserConnector.ts#L72\n    const puppeteerConnection = new PuppeteerConnection('', transport);\n\n    const browserPromise = puppeteer.Browser._create(\n        'chrome',\n        puppeteerConnection,\n        [] /* contextIds */,\n        false /* ignoreHTTPSErrors */,\n        undefined /* defaultViewport */,\n        undefined /* process */,\n        undefined /* closeCallback */,\n        undefined,\n        target => isPageTargetCallback((target as puppeteer.Target)._getTargetInfo()),\n        false /* waitForInitiallyDiscoveredTargets */,\n    );\n\n    const [, browser] = await Promise.all([\n      puppeteerConnection._createSession({targetId: rootTargetId}, /* emulateAutoAttach= */ true),\n      browserPromise,\n    ]);\n\n    await browser.waitForTarget(t => t.type() === 'page');\n\n    const pages = await browser.pages();\n\n    return {page: pages[0] as puppeteer.Page, browser, puppeteerConnection};\n  }\n}\n"]}