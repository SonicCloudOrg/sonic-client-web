{"version":3,"file":"InteractionsTrackAppender.test.js","sourceRoot":"","sources":["../../../../../../../front_end/panels/timeline/track_appenders/InteractionsTrackAppender.test.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2023 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as TraceEngine from '../../../models/trace/trace.js';\nimport {describeWithEnvironment} from '../../../testing/EnvironmentHelpers.js';\nimport {TraceLoader} from '../../../testing/TraceLoader.js';\nimport * as PerfUI from '../../../ui/legacy/components/perf_ui/perf_ui.js';\nimport * as Timeline from '../timeline.js';\n\nfunction initTrackAppender(\n    flameChartData: PerfUI.FlameChart.FlameChartTimelineData,\n    traceParsedData: TraceEngine.Handlers.Types.TraceParseData,\n    entryData: Timeline.TimelineFlameChartDataProvider.TimelineFlameChartEntry[],\n    entryTypeByLevel: Timeline.TimelineFlameChartDataProvider.EntryType[],\n    ): Timeline.InteractionsTrackAppender.InteractionsTrackAppender {\n  const compatibilityTracksAppender = new Timeline.CompatibilityTracksAppender.CompatibilityTracksAppender(\n      flameChartData, traceParsedData, entryData, entryTypeByLevel);\n  return compatibilityTracksAppender.interactionsTrackAppender();\n}\n\ndescribeWithEnvironment('InteractionsTrackAppender', function() {\n  async function renderTrackAppender(context: Mocha.Suite|Mocha.Context, trace: string): Promise<{\n    entryTypeByLevel: Timeline.TimelineFlameChartDataProvider.EntryType[],\n    flameChartData: PerfUI.FlameChart.FlameChartTimelineData,\n    interactionsTrackAppender: Timeline.InteractionsTrackAppender.InteractionsTrackAppender,\n    entryData: Timeline.TimelineFlameChartDataProvider.TimelineFlameChartEntry[],\n    traceParsedData: Readonly<TraceEngine.Handlers.Types.TraceParseData>,\n  }> {\n    const entryTypeByLevel: Timeline.TimelineFlameChartDataProvider.EntryType[] = [];\n    const entryData: Timeline.TimelineFlameChartDataProvider.TimelineFlameChartEntry[] = [];\n    const flameChartData = PerfUI.FlameChart.FlameChartTimelineData.createEmpty();\n    const traceParsedData = await TraceLoader.traceEngine(context, trace);\n    const interactionsTrackAppender = initTrackAppender(flameChartData, traceParsedData, entryData, entryTypeByLevel);\n    interactionsTrackAppender.appendTrackAtLevel(0);\n\n    return {\n      entryTypeByLevel,\n      traceParsedData,\n      flameChartData,\n      interactionsTrackAppender,\n      entryData,\n    };\n  }\n\n  describe('appendTrackAtLevel', function() {\n    it('marks all levels used by the track with the `TrackAppender` type', async function() {\n      const {entryTypeByLevel} = await renderTrackAppender(this, 'slow-interaction-button-click.json.gz');\n      // All events fit on the top level\n      assert.strictEqual(entryTypeByLevel.length, 1);\n      assert.deepEqual(entryTypeByLevel, [\n        Timeline.TimelineFlameChartDataProvider.EntryType.TrackAppender,\n      ]);\n    });\n\n    it('takes over no levels if there are no interactions', async function() {\n      // animation trace has no interactions in it.\n      const {entryTypeByLevel} = await renderTrackAppender(this, 'animation.json.gz');\n      assert.strictEqual(entryTypeByLevel.length, 0);\n    });\n\n    it('only shows the top level interactions', async function() {\n      const {entryData, traceParsedData} = await renderTrackAppender(this, 'nested-interactions.json.gz');\n      assert.strictEqual(entryData.length, traceParsedData.UserInteractions.interactionEventsWithNoNesting.length);\n    });\n\n    it('creates a flamechart group', async function() {\n      const {flameChartData} = await renderTrackAppender(this, 'slow-interaction-button-click.json.gz');\n      assert.strictEqual(flameChartData.groups.length, 1);\n      assert.strictEqual(flameChartData.groups[0].name, 'Interactions');\n    });\n\n    it('adds all interactions with the correct start times', async function() {\n      const {flameChartData, traceParsedData, entryData} =\n          await renderTrackAppender(this, 'slow-interaction-button-click.json.gz');\n      const events = traceParsedData.UserInteractions.interactionEventsWithNoNesting;\n      for (const event of events) {\n        const markerIndex = entryData.indexOf(event);\n        assert.exists(markerIndex);\n        assert.strictEqual(\n            flameChartData.entryStartTimes[markerIndex],\n            TraceEngine.Helpers.Timing.microSecondsToMilliseconds(event.ts));\n      }\n    });\n\n    it('adds total times correctly', async function() {\n      const {flameChartData, traceParsedData, entryData} =\n          await renderTrackAppender(this, 'slow-interaction-button-click.json.gz');\n      const events = traceParsedData.UserInteractions.interactionEventsWithNoNesting;\n      for (const event of events) {\n        const markerIndex = entryData.indexOf(event);\n        assert.exists(markerIndex);\n        const expectedTotalTimeForEvent = TraceEngine.Helpers.Timing.microSecondsToMilliseconds(\n            (event.dur || 0) as TraceEngine.Types.Timing.MicroSeconds);\n        assert.strictEqual(flameChartData.entryTotalTimes[markerIndex], expectedTotalTimeForEvent);\n      }\n    });\n  });\n\n  it('candy-stripes and adds warning triangles to long interactions', async function() {\n    const {traceParsedData, flameChartData, entryData} =\n        await renderTrackAppender(this, 'one-second-interaction.json.gz');\n    const longInteraction = traceParsedData.UserInteractions.longestInteractionEvent;\n    if (!longInteraction) {\n      throw new Error('Could not find longest interaction');\n    }\n    const entryIndex = entryData.indexOf(longInteraction);\n    const decorationsForEntry = flameChartData.entryDecorations[entryIndex];\n    assert.deepEqual(decorationsForEntry, [\n      {\n        type: PerfUI.FlameChart.FlameChartDecorationType.CANDY,\n        startAtTime: TraceEngine.Types.Timing.MicroSeconds(200_000),\n        endAtTime: longInteraction.processingEnd,\n      },\n      {\n        type: PerfUI.FlameChart.FlameChartDecorationType.WARNING_TRIANGLE,\n        customEndTime: longInteraction.processingEnd,\n      },\n    ]);\n  });\n\n  it('does not candy-stripe interactions less than 200ms', async function() {\n    const {flameChartData} = await renderTrackAppender(this, 'slow-interaction-button-click.json.gz');\n    // None of the interactions are over 200ms, so we do not expect to see any decorations\n    assert.lengthOf(flameChartData.entryDecorations, 0);\n  });\n\n  it('returns the correct title for a pointer interaction, using its category', async function() {\n    const {interactionsTrackAppender, traceParsedData} =\n        await renderTrackAppender(this, 'slow-interaction-button-click.json.gz');\n    const firstInteraction = traceParsedData.UserInteractions.interactionEvents[0];\n    const title = interactionsTrackAppender.titleForEvent(firstInteraction);\n    assert.strictEqual(title, 'Pointer');\n  });\n\n  it('returns the correct title for a keyboard interaction, using its category', async function() {\n    const {interactionsTrackAppender, traceParsedData} =\n        await renderTrackAppender(this, 'slow-interaction-keydown.json.gz');\n    const keydownInteraction = traceParsedData.UserInteractions.interactionEvents.find(e => e.type === 'keydown');\n    if (!keydownInteraction) {\n      throw new Error('Could not find keydown interaction');\n    }\n    const title = interactionsTrackAppender.titleForEvent(keydownInteraction);\n    assert.strictEqual(title, 'Keyboard');\n  });\n\n  it('returns \"Other\" as the title for unknown event types', async function() {\n    const {interactionsTrackAppender, traceParsedData} =\n        await renderTrackAppender(this, 'slow-interaction-button-click.json.gz');\n\n    // Copy the event so we do not modify the actual trace data, and fake its\n    // interaction type to be unexpected.\n    const firstInteraction = {...traceParsedData.UserInteractions.interactionEvents[0]};\n    firstInteraction.type = 'unknown';\n\n    const title = interactionsTrackAppender.titleForEvent(firstInteraction);\n    assert.strictEqual(title, 'Other');\n  });\n\n  it('highlightedEntryInfo returns the correct information', async function() {\n    const {interactionsTrackAppender, traceParsedData} =\n        await renderTrackAppender(this, 'slow-interaction-button-click.json.gz');\n    const firstInteraction = traceParsedData.UserInteractions.interactionEvents[0];\n    const highlightedEntryInfo = interactionsTrackAppender.highlightedEntryInfo(firstInteraction);\n    // The i18n encodes spaces using the u00A0 unicode character.\n    assert.strictEqual(highlightedEntryInfo.formattedTime, ('31.72\\u00A0ms'));\n  });\n});\n"]}