{"version":3,"file":"FreestylerAgent.js","sourceRoot":"","sources":["../../../../../../front_end/panels/freestyler/FreestylerAgent.ts"],"names":[],"mappings":"AAAA,4DAA4D;AAC5D,yEAAyE;AACzE,6BAA6B;AAE7B,OAAO,KAAK,MAAM,MAAM,6BAA6B,CAAC;AAEtD,OAAO,KAAK,GAAG,MAAM,uBAAuB,CAAC;AAC7C,OAAO,KAAK,EAAE,MAAM,2BAA2B,CAAC;AAEhD,OAAO,EAAC,wBAAwB,EAAC,MAAM,+BAA+B,CAAC;AAEvE,mBAAmB;AACnB,MAAM,aAAa,GAAG;;;;;;;;;;;;;;;;;;;;;;;;;IAyBlB,CAAC;AACL,kBAAkB;AAElB,MAAM,CAAN,IAAY,IAKX;AALD,WAAY,IAAI;IACd,2BAAmB,CAAA;IACnB,yBAAiB,CAAA;IACjB,mCAA2B,CAAA;IAC3B,yBAAiB,CAAA;AACnB,CAAC,EALW,IAAI,KAAJ,IAAI,QAKf;AAED,KAAK,UAAU,aAAa,CAAC,IAAY;IACvC,MAAM,MAAM,GAAG,EAAE,CAAC,OAAO,CAAC,OAAO,CAAC,QAAQ,EAAE,CAAC,MAAM,CAAC,GAAG,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC;IACvE,IAAI,CAAC,MAAM,EAAE,CAAC;QACZ,MAAM,IAAI,KAAK,CAAC,wCAAwC,CAAC,CAAC;IAC5D,CAAC;IAED,MAAM,iBAAiB,GAAG,MAAM,CAAC,KAAK,CAAC,GAAG,CAAC,iBAAiB,CAAC,iBAAiB,CAAC,CAAC;IAChF,MAAM,YAAY,GAAG,MAAM,CAAC,KAAK,CAAC,GAAG,CAAC,YAAY,CAAC,YAAY,CAAC,CAAC;IACjE,MAAM,SAAS,GAAG,MAAM,CAAC,SAAS,EAAE,CAAC;IACrC,IAAI,CAAC,iBAAiB,EAAE,SAAS,EAAE,CAAC;QAClC,MAAM,IAAI,KAAK,CAAC,4CAA4C,CAAC,CAAC;IAChE,CAAC;IAED,oEAAoE;IACpE,MAAM,EAAC,kBAAkB,EAAC,GAAG,MAAM,SAAS,CAAC,0BAA0B,CACnE,EAAC,OAAO,EAAE,iBAAiB,CAAC,SAAS,CAAC,EAAE,EAAE,SAAS,EAAE,qBAAqB,EAAC,CAAC,CAAC;IACjF,MAAM,gBAAgB,GAAG,YAAY,EAAE,gBAAgB,CAAC,kBAAkB,CAAC,CAAC;IAC5E,IAAI,CAAC,gBAAgB,EAAE,CAAC;QACtB,MAAM,IAAI,KAAK,CAAC,mDAAmD,CAAC,CAAC;IACvE,CAAC;IAED,OAAO,wBAAwB,CAAC,OAAO,CAAC,IAAI,EAAE,gBAAgB,CAAC,CAAC;AAClE,CAAC;AAED,MAAM,aAAa,GAAG,gBAAgB,CAAC;AACvC,MAAM,YAAY,GAAG,iBAAiB,CAAC;AACvC,MAAM,aAAa,GAAG,8BAA8B,CAAC;AACrD,MAAM,YAAY,GAAG,4BAA4B,CAAC;AAClD,MAAM,SAAS,GAAG,CAAC,CAAC;AACpB,MAAM,OAAO,eAAe;IAC1B,WAAW,CAA6B;IAExC,YAAY,EAAC,UAAU,EAA2C;QAChE,IAAI,CAAC,WAAW,GAAG,UAAU,CAAC;IAChC,CAAC;IAED,MAAM,CAAC,YAAY,CAAC,KAAa,EAAE,QAAiB,EAAE,WAAqC;QAEzF,MAAM,MAAM,GAAG,MAAM,CAAC,QAAQ,CAAC,QAAQ,CAAC,QAAQ,EAAE,CAAC,aAAa,EAAE,CAAC;QACnE,MAAM,OAAO,GAAgC;YAC3C,KAAK;YACL,QAAQ;YACR,gEAAgE;YAChE,YAAY,EAAE,WAAW;YACzB,MAAM,EAAE,iBAAiB;YACzB,OAAO,EAAE;gBACP,sCAAsC;gBACtC,WAAW,EAAE,CAAC;gBACd,2CAA2C;gBAC3C,QAAQ,EAAE,MAAM,EAAE,8BAA8B,CAAC,WAAW,IAAI,MAAM,EAAE,uBAAuB,CAAC,WAAW;oBACvG,SAAS;aACd;YACD,QAAQ,EAAE;gBACR,8BAA8B;gBAC9B,4BAA4B,EAAE,IAAI;aACnC;SACF,CAAC;QACF,OAAO,OAAO,CAAC;IACjB,CAAC;IAED,KAAK,CAAC,iBAAiB,CAAC,IAAY;QAClC,IAAI,MAAM,CAAC;QACX,IAAI,KAAK,EAAE,MAAM,UAAU,IAAI,IAAI,CAAC,WAAW,CAAC,KAAK,CAAC,eAAe,CAAC,YAAY,CAAC,IAAI,CAAC,CAAC,EAAE,CAAC;YAC1F,MAAM,GAAG,UAAU,CAAC,WAAW,CAAC;QAClC,CAAC;QAED,OAAO,MAAM,IAAI,EAAE,CAAC;IACtB,CAAC;IAED,KAAK,CAAC,GAAG,CAAC,KAAa,EAAE,MAAgD;QACvE,MAAM,OAAO,GAAgB,IAAI,GAAG,CAAC,CAAC,aAAa,EAAE,KAAK,CAAC,CAAC,CAAC;QAC7D,MAAM,aAAa,GAAG,EAAE,CAAC;QACzB,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,SAAS,EAAE,CAAC,EAAE,EAAE,CAAC;YACnC,MAAM,cAAc,GAAG,CAAC,GAAG,OAAO,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YAC/C,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,iBAAiB,CAAC,cAAc,CAAC,CAAC;YAC1D,QAAQ,CAAC,cAAc,CAAC,KAAK,cAAc,KAAK,IAAI,EAAE,CAAC,CAAC;YACxD,aAAa,CAAC,IAAI,CAAC;gBACjB,MAAM,EAAE,cAAc;gBACtB,QAAQ,EAAE,IAAI;aACf,CAAC,CAAC;YAEH,MAAM,YAAY,GAAG,IAAI,CAAC,KAAK,CAAC,aAAa,CAAC,CAAC;YAC/C,IAAI,YAAY,EAAE,CAAC;gBACjB,MAAM,WAAW,GAAG,YAAY,CAAC,CAAC,CAAC,CAAC;gBACpC,MAAM,CAAC,IAAI,CAAC,OAAO,EAAE,WAAW,CAAC,CAAC;gBAClC,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;YACpB,CAAC;YAED,MAAM,WAAW,GAAG,IAAI,CAAC,KAAK,CAAC,YAAY,CAAC,CAAC;YAC7C,IAAI,WAAW,EAAE,CAAC;gBAChB,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;gBAClB,MAAM,UAAU,GAAG,WAAW,CAAC,CAAC,CAAC,CAAC;gBAClC,MAAM,YAAY,GAAG,UAAU,CAAC,KAAK,CAAC,aAAa,CAAC,CAAC;gBACrD,IAAI,YAAY,EAAE,CAAC;oBACjB,MAAM,MAAM,GAAG,YAAY,CAAC,CAAC,CAAC,CAAC;oBAC/B,MAAM,WAAW,GAAG,MAAM,aAAa,CAAC,IAAI,MAAM,QAAQ,CAAC,CAAC;oBAC5D,QAAQ,CAAC,oBAAoB,MAAM,aAAa,WAAW,EAAE,CAAC,CAAC;oBAC/D,MAAM,CAAC,IAAI,CAAC,MAAM,EAAE,UAAU,CAAC,CAAC;oBAChC,OAAO,CAAC,GAAG,CAAC,kBAAkB,WAAW,EAAE,CAAC,CAAC;gBAC/C,CAAC;gBAED,MAAM,WAAW,GAAG,UAAU,CAAC,KAAK,CAAC,YAAY,CAAC,CAAC;gBACnD,IAAI,WAAW,EAAE,CAAC;oBAChB,MAAM,UAAU,GAAG,WAAW,CAAC,CAAC,CAAC,CAAC;oBAClC,MAAM,CAAC,IAAI,CAAC,MAAM,EAAE,UAAU,CAAC,CAAC;oBAChC,MAAM;gBACR,CAAC;YACH,CAAC;QACH,CAAC;QACD,IAAI,WAAW,EAAE,EAAE,CAAC;YAClB,YAAY,CAAC,OAAO,CAAC,yBAAyB,EAAE,IAAI,CAAC,SAAS,CAAC,aAAa,CAAC,CAAC,CAAC;YAC/E,MAAM,CAAC,aAAa,CAAC,IAAI,WAAW,CAAC,gBAAgB,CAAC,CAAC,CAAC;QAC1D,CAAC;IACH,CAAC;CACF;AAED,SAAS,WAAW;IAClB,OAAO,OAAO,CAAC,YAAY,CAAC,OAAO,CAAC,wBAAwB,CAAC,CAAC,CAAC;AACjE,CAAC;AAED,SAAS,QAAQ,CAAC,GAAW;IAC3B,IAAI,CAAC,WAAW,EAAE,EAAE,CAAC;QACnB,OAAO;IACT,CAAC;IAED,sCAAsC;IACtC,OAAO,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;AACnB,CAAC;AAED,SAAS,yBAAyB,CAAC,OAAgB;IACjD,IAAI,OAAO,EAAE,CAAC;QACZ,YAAY,CAAC,OAAO,CAAC,wBAAwB,EAAE,MAAM,CAAC,CAAC;IACzD,CAAC;SAAM,CAAC;QACN,YAAY,CAAC,UAAU,CAAC,wBAAwB,CAAC,CAAC;IACpD,CAAC;AACH,CAAC;AAED,aAAa;AACb,UAAU,CAAC,yBAAyB,GAAG,yBAAyB,CAAC","sourcesContent":["// Copyright 2024 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Common from '../../core/common/common.js';\nimport type * as Host from '../../core/host/host.js';\nimport * as SDK from '../../core/sdk/sdk.js';\nimport * as UI from '../../ui/legacy/legacy.js';\n\nimport {FreestylerEvaluateAction} from './FreestylerEvaluateAction.js';\n\n// clang-format off\nconst SYSTEM_PROMPT = `Solve a question answering task about the page with interleaving Thought, Action, Observation steps.\nThought can reason about the current situation, Observation is understanding relevant information from an Action's output and Action can be of two types:\n(1) <execute>entity</execute>, which executes JavaScript code on a page and returns the result of code execution. If not, it will return some similar entities to search and you can try to search the information from those topics. You have access to $0 variable to denote the currently inspected element while executing JS code.\n(2) <finish>answer</finish>, which returns the answer and finishes the task.\nYou can only execute one action.\n\n* PUT THE INFORMATION YOU WANT TO RETRIEVE INSIDE 'data' object.\n\nHere is an example:\n\nThought\nTo solve the task I need to know the height of the current element.\n\nAction\n<execute>\n const data = {\n  currentElementHeight: window.getComputedStyle($0).height\n }\n</execute>\n\nObservation\n{\n  currentElementHeight: 300\n}\n\n===`;\n// clang-format on\n\nexport enum Step {\n  THOUGHT = 'thought',\n  ACTION = 'action',\n  OBSERVATION = 'observation',\n  ANSWER = 'answer',\n}\n\nasync function executeJsCode(code: string): Promise<string> {\n  const target = UI.Context.Context.instance().flavor(SDK.Target.Target);\n  if (!target) {\n    throw new Error('Target is not found for executing code');\n  }\n\n  const resourceTreeModel = target.model(SDK.ResourceTreeModel.ResourceTreeModel);\n  const runtimeModel = target.model(SDK.RuntimeModel.RuntimeModel);\n  const pageAgent = target.pageAgent();\n  if (!resourceTreeModel?.mainFrame) {\n    throw new Error('Main frame is not found for executing code');\n  }\n\n  // This returns previously created world if it exists for the frame.\n  const {executionContextId} = await pageAgent.invoke_createIsolatedWorld(\n      {frameId: resourceTreeModel.mainFrame.id, worldName: 'devtools_freestyler'});\n  const executionContext = runtimeModel?.executionContext(executionContextId);\n  if (!executionContext) {\n    throw new Error('Execution context is not found for executing code');\n  }\n\n  return FreestylerEvaluateAction.execute(code, executionContext);\n}\n\nconst THOUGHT_REGEX = /^Thought\\n(.*)/;\nconst ACTION_REGEX = /^Action\\n(.*)/ms;\nconst EXECUTE_REGEX = /^<execute>(.*)<\\/execute>$/ms;\nconst FINISH_REGEX = /^<finish>(.*)<\\/finish>$/ms;\nconst MAX_STEPS = 5;\nexport class FreestylerAgent {\n  #aidaClient: Host.AidaClient.AidaClient;\n\n  constructor({aidaClient}: {aidaClient: Host.AidaClient.AidaClient}) {\n    this.#aidaClient = aidaClient;\n  }\n\n  static buildRequest(input: string, preamble?: string, chatHistory?: Host.AidaClient.Chunk[]):\n      Host.AidaClient.AidaRequest {\n    const config = Common.Settings.Settings.instance().getHostConfig();\n    const request: Host.AidaClient.AidaRequest = {\n      input,\n      preamble,\n      // eslint-disable-next-line @typescript-eslint/naming-convention\n      chat_history: chatHistory,\n      client: 'CHROME_DEVTOOLS',\n      options: {\n        // TODO: have a config for temperature\n        temperature: 0,\n        // TODO: have a separate config for modelId\n        model_id: config?.devToolsConsoleInsightsDogfood.aidaModelId ?? config?.devToolsConsoleInsights.aidaModelId ??\n            undefined,\n      },\n      metadata: {\n        // TODO: enable logging later.\n        disable_user_content_logging: true,\n      },\n    };\n    return request;\n  }\n\n  async #aidaAutocomplete(text: string): Promise<string> {\n    let result;\n    for await (const lastResult of this.#aidaClient.fetch(FreestylerAgent.buildRequest(text))) {\n      result = lastResult.explanation;\n    }\n\n    return result ?? '';\n  }\n\n  async run(query: string, onStep: (step: Step, stepOutput: string) => void): Promise<void> {\n    const prompts: Set<string> = new Set([SYSTEM_PROMPT, query]);\n    const structuredLog = [];\n    for (let i = 0; i < MAX_STEPS; i++) {\n      const combinedPrompt = [...prompts].join('\\n');\n      const step = await this.#aidaAutocomplete(combinedPrompt);\n      debugLog(`Iteration: ${i}: ${combinedPrompt}\\n${step}`);\n      structuredLog.push({\n        prompt: combinedPrompt,\n        response: step,\n      });\n\n      const thoughtMatch = step.match(THOUGHT_REGEX);\n      if (thoughtMatch) {\n        const thoughtText = thoughtMatch[1];\n        onStep(Step.THOUGHT, thoughtText);\n        prompts.add(step);\n      }\n\n      const actionMatch = step.match(ACTION_REGEX);\n      if (actionMatch) {\n        prompts.add(step);\n        const actionText = actionMatch[1];\n        const executeMatch = actionText.match(EXECUTE_REGEX);\n        if (executeMatch) {\n          const jsCode = executeMatch[1];\n          const observation = await executeJsCode(`{${jsCode};data}`);\n          debugLog(`Executed action: ${jsCode}\\nResult: ${observation}`);\n          onStep(Step.ACTION, actionText);\n          prompts.add(`\\nObservation\\n${observation}`);\n        }\n\n        const finishMatch = actionText.match(FINISH_REGEX);\n        if (finishMatch) {\n          const finishText = finishMatch[1];\n          onStep(Step.ANSWER, finishText);\n          break;\n        }\n      }\n    }\n    if (isDebugMode()) {\n      localStorage.setItem('freestylerStructuredLog', JSON.stringify(structuredLog));\n      window.dispatchEvent(new CustomEvent('freestylerdone'));\n    }\n  }\n}\n\nfunction isDebugMode(): boolean {\n  return Boolean(localStorage.getItem('debugFreestylerEnabled'));\n}\n\nfunction debugLog(log: string): void {\n  if (!isDebugMode()) {\n    return;\n  }\n\n  // eslint-disable-next-line no-console\n  console.log(log);\n}\n\nfunction setDebugFreestylerEnabled(enabled: boolean): void {\n  if (enabled) {\n    localStorage.setItem('debugFreestylerEnabled', 'true');\n  } else {\n    localStorage.removeItem('debugFreestylerEnabled');\n  }\n}\n\n// @ts-ignore\nglobalThis.setDebugFreestylerEnabled = setDebugFreestylerEnabled;\n"]}