{"version":3,"file":"FreestylerEvaluateAction.test.js","sourceRoot":"","sources":["../../../../../../front_end/panels/freestyler/FreestylerEvaluateAction.test.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2024 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as SDK from '../../core/sdk/sdk.js';\nimport * as Protocol from '../../generated/protocol.js';\nimport {describeWithRealConnection, getExecutionContext} from '../../testing/RealConnection.js';\n\nimport * as Freestyler from './FreestylerEvaluateAction.js';\n\ndescribe('FreestylerEvaluateAction', () => {\n  describe('error handling', () => {\n    function executeWithResult(mockResult: SDK.RuntimeModel.EvaluationResult): Promise<string> {\n      const executionContextStub = sinon.createStubInstance(SDK.RuntimeModel.ExecutionContext);\n      executionContextStub.evaluate.resolves(mockResult);\n      return Freestyler.FreestylerEvaluateAction.execute('', executionContextStub);\n    }\n\n    function mockRemoteObject(overrides: Partial<SDK.RemoteObject.RemoteObject> = {}): SDK.RemoteObject.RemoteObject {\n      return sinon.createStubInstance(SDK.RemoteObject.RemoteObject, {\n        ...(overrides.className ? {className: overrides.className} : null),\n        ...(overrides.subtype ? {subtype: overrides.subtype} : null),\n        ...(overrides.type ? {type: overrides.type} : null),\n        ...(overrides.value ? {value: overrides.value} : null),\n        ...(overrides.preview ? {preview: overrides.preview} : null),\n      });\n    }\n\n    function mockExceptionDetails({description}: {description: string}): Protocol.Runtime.ExceptionDetails {\n      return {\n        exceptionId: 3,\n        text: 'SyntaxError',\n        lineNumber: 3,\n        columnNumber: 3,\n        exception: {type: Protocol.Runtime.RemoteObjectType.String, description},\n      };\n    }\n\n    beforeEach(() => {\n      sinon.restore();\n    });\n\n    it('should throw an ExecutionError when the page returned with an error message', async () => {\n      try {\n        await executeWithResult({error: 'errorMessage'});\n      } catch (err) {\n        assert.instanceOf(err, Freestyler.ExecutionError);\n        assert.strictEqual(err.message, 'errorMessage');\n      }\n    });\n\n    it('should throw an ExecutionError with the description of the exception if response included exception details',\n       async () => {\n         try {\n           await executeWithResult({\n             object: mockRemoteObject(),\n             exceptionDetails: mockExceptionDetails({description: 'Error description'}),\n           });\n         } catch (err) {\n           assert.instanceOf(err, Freestyler.ExecutionError);\n           assert.strictEqual(err.message, 'Error description');\n         }\n       });\n  });\n\n  describeWithRealConnection('serialization', () => {\n    async function executionContextForTest() {\n      const targetManager = SDK.TargetManager.TargetManager.instance();\n      const target = targetManager.rootTarget();\n      const runtimeModel = target!.model(SDK.RuntimeModel.RuntimeModel);\n      return getExecutionContext(runtimeModel!);\n    }\n\n    async function executeForTest(\n        code: string, {allowSideEffectForTest = false}: {allowSideEffectForTest?: boolean} = {}) {\n      return Freestyler.FreestylerEvaluateAction.execute(\n          code, await executionContextForTest(), {allowSideEffectForTest});\n    }\n\n    it('should serialize primitive values correctly', async () => {\n      assert.strictEqual(await executeForTest('\"string\"'), '\\'string\\'');\n      assert.strictEqual(await executeForTest('999n'), '999n');\n      assert.strictEqual(await executeForTest('true'), 'true');\n      assert.strictEqual(await executeForTest('undefined'), 'undefined');\n      assert.strictEqual(await executeForTest('42'), '42');\n      assert.strictEqual(await executeForTest('Symbol(\"sym\")'), 'Symbol(sym)');\n    });\n\n    it('should serialize DOM nodes correctly', async () => {\n      assert.strictEqual(\n          await executeForTest(\n              `{\n        const div = document.createElement('div');\n        div.setAttribute('data-custom-attr', 'i exist');\n        div\n      }`,\n              {allowSideEffectForTest: true}),\n          '\"<div data-custom-attr=\\\\\"i exist\\\\\"></div>\"');\n    });\n\n    it('should serialize arrays correctly', async () => {\n      assert.strictEqual(await executeForTest('[]'), '[]');\n      assert.strictEqual(await executeForTest('[1]'), '[1]');\n      assert.strictEqual(await executeForTest('[1, 2]'), '[1,2]');\n      assert.strictEqual(await executeForTest('[{key: 1}]'), '[{\"key\":1}]');\n    });\n\n    it('should serialize objects correctly', async () => {\n      assert.strictEqual(await executeForTest('{const object = {key: \"str\"}; object}'), '{\"key\":\"str\"}');\n      assert.strictEqual(\n          await executeForTest('{const object = {key: \"str\", secondKey: \"str2\"}; object}'),\n          '{\"key\":\"str\",\"secondKey\":\"str2\"}');\n      assert.strictEqual(await executeForTest('{const object = {key: 1}; object}'), '{\"key\":1}');\n    });\n\n    it('should not continue serializing cycles', async () => {\n      assert.strictEqual(\n          await executeForTest(`{\n        const obj = { a: 1 };\n        obj.itself = obj;\n        obj\n      }`),\n          '{\"a\":1,\"itself\":\"(cycle)\"}');\n    });\n\n    it('should not include number keys for CSSStyleDeclaration', async () => {\n      const result = await executeForTest('getComputedStyle(document.body)');\n      const parsedResult = JSON.parse(result);\n      assert.isUndefined(parsedResult[0]);\n    });\n  });\n});\n"]}