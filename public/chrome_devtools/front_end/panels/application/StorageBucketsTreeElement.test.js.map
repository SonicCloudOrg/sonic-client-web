{"version":3,"file":"StorageBucketsTreeElement.test.js","sourceRoot":"","sources":["../../../../../../front_end/panels/application/StorageBucketsTreeElement.test.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2023 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Root from '../../core/root/root.js';\nimport * as SDK from '../../core/sdk/sdk.js';\nimport * as Protocol from '../../generated/protocol.js';\nimport {\n  createTarget,\n  stubNoopSettings,\n} from '../../testing/EnvironmentHelpers.js';\nimport {describeWithMockConnection} from '../../testing/MockConnection.js';\nimport * as UI from '../../ui/legacy/legacy.js';\n\nimport * as Application from './application.js';\n\ndescribeWithMockConnection('StorageBucketsTreeElement', function() {\n  let target: SDK.Target.Target;\n  let storageKeyManager: SDK.StorageKeyManager.StorageKeyManager;\n  let storageBucketsModel: SDK.StorageBucketsModel.StorageBucketsModel|null;\n\n  const STORAGE_KEYS: string[] = [\n    'storagekey1',\n    'storagekey2',\n    'storagekey3',\n  ];\n\n  const STORAGE_BUCKET_INFOS: Protocol.Storage.StorageBucketInfo[] = [\n    {\n      bucket: {\n        storageKey: STORAGE_KEYS[0],\n      },\n      id: '0',\n      expiration: 0,\n      quota: 0,\n      persistent: false,\n      durability: Protocol.Storage.StorageBucketsDurability.Strict,\n    },\n    {\n      bucket: {\n        storageKey: STORAGE_KEYS[0],\n        name: 'bucket1',\n      },\n      id: '1',\n      expiration: 0,\n      quota: 0,\n      persistent: false,\n      durability: Protocol.Storage.StorageBucketsDurability.Strict,\n    },\n    {\n      bucket: {\n        storageKey: STORAGE_KEYS[1],\n        name: 'bucket2',\n      },\n      id: '2',\n      expiration: 0,\n      quota: 0,\n      persistent: false,\n      durability: Protocol.Storage.StorageBucketsDurability.Strict,\n    },\n    {\n      bucket: {\n        storageKey: STORAGE_KEYS[2],\n        name: 'bucket3',\n      },\n      id: '3',\n      expiration: 0,\n      quota: 0,\n      persistent: false,\n      durability: Protocol.Storage.StorageBucketsDurability.Strict,\n    },\n  ];\n\n  const getBucketsForStorageKeys = (...storageKeys: string[]) => {\n    return STORAGE_BUCKET_INFOS.filter(({bucket}) => storageKeys.includes(bucket.storageKey));\n  };\n\n  const getNonDefaultBuckets = () => {\n    return STORAGE_BUCKET_INFOS.filter(({bucket}) => bucket.name !== undefined);\n  };\n\n  const setStorageBucketTrackingStub = ({storageKey}: {storageKey: string}) => {\n    assert.exists(storageBucketsModel);\n    for (const bucketInfo of getBucketsForStorageKeys(storageKey)) {\n      storageBucketsModel.storageBucketCreatedOrUpdated({bucketInfo});\n    }\n    return Promise.resolve({\n      getError: () => undefined,\n    });\n  };\n\n  beforeEach(async () => {\n    stubNoopSettings();\n    SDK.ChildTargetManager.ChildTargetManager.install();\n    const tabTarget = createTarget({type: SDK.Target.Type.Tab});\n    createTarget({parentTarget: tabTarget, subtype: 'prerender'});\n    target = createTarget({parentTarget: tabTarget});\n    Root.Runtime.experiments.register(Root.Runtime.ExperimentName.PRELOADING_STATUS_PANEL, '', false);\n\n    storageKeyManager =\n        target.model(SDK.StorageKeyManager.StorageKeyManager) as SDK.StorageKeyManager.StorageKeyManager;\n    storageBucketsModel = target.model(SDK.StorageBucketsModel.StorageBucketsModel);\n  });\n\n  it('adds bucket tree elements on non default buckets added', async () => {\n    assert.exists(storageBucketsModel);\n\n    sinon.stub(storageBucketsModel.storageAgent, 'invoke_setStorageBucketTracking')\n        .callsFake(setStorageBucketTrackingStub);\n    storageKeyManager.updateStorageKeys(new Set(STORAGE_KEYS));\n    storageBucketsModel.enable();\n\n    const panel = Application.ResourcesPanel.ResourcesPanel.instance({forceNew: true});\n    panel.markAsRoot();\n    panel.show(document.body);\n\n    const parentTreeElement = new Application.StorageBucketsTreeElement.StorageBucketsTreeParentElement(panel);\n    const appendChildSpy = sinon.spy(parentTreeElement, 'appendChild');\n    parentTreeElement.initialize();\n\n    assert.strictEqual(appendChildSpy.callCount, getNonDefaultBuckets().length);\n\n    panel.detach();\n  });\n\n  it('shows view on select', async () => {\n    assert.exists(storageBucketsModel);\n\n    const panel = Application.ResourcesPanel.ResourcesPanel.instance({forceNew: true});\n    panel.markAsRoot();\n    panel.show(document.body);\n\n    const treeElement = new Application.StorageBucketsTreeElement.StorageBucketsTreeElement(\n        panel, storageBucketsModel, STORAGE_BUCKET_INFOS[0]);\n\n    const showViewSpy = sinon.spy(treeElement, 'showView');\n\n    document.body.appendChild(treeElement.listItemNode);\n    treeElement.treeOutline = new UI.TreeOutline.TreeOutlineInShadow();\n    treeElement.selectable = true;\n    treeElement.select();\n\n    assert.isTrue(showViewSpy.calledOnce);\n\n    panel.detach();\n  });\n});\n"]}