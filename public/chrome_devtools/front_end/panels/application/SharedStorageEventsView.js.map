{"version":3,"file":"SharedStorageEventsView.js","sourceRoot":"","sources":["../../../../../../front_end/panels/application/SharedStorageEventsView.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2022 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as i18n from '../../core/i18n/i18n.js';\nimport * as SDK from '../../core/sdk/sdk.js';\nimport type * as Protocol from '../../generated/protocol.js';\nimport type * as DataGrid from '../../ui/components/data_grid/data_grid.js';\nimport * as SourceFrame from '../../ui/legacy/components/source_frame/source_frame.js';\nimport * as UI from '../../ui/legacy/legacy.js';\nimport * as VisualLogging from '../../ui/visual_logging/visual_logging.js';\n\nimport * as ApplicationComponents from './components/components.js';\nimport sharedStorageEventsViewStyles from './sharedStorageEventsView.css.js';\n\nconst UIStrings = {\n  /**\n   *@description Placeholder text instructing the user how to display shared\n   *storage event details.\n   */\n  clickToDisplayBody: 'Click on any shared storage event to display the event parameters.',\n};\nconst str_ = i18n.i18n.registerUIStrings('panels/application/SharedStorageEventsView.ts', UIStrings);\nconst i18nString = i18n.i18n.getLocalizedString.bind(undefined, str_);\n\ninterface WrappedEvent {\n  accessTime: string;\n  accessType: string;\n  ownerOrigin: string;\n  eventParams: Object;\n}\n\nfunction eventEquals(\n    a: Protocol.Storage.SharedStorageAccessedEvent, b: Protocol.Storage.SharedStorageAccessedEvent): boolean {\n  return JSON.stringify(a) === JSON.stringify(b);\n}\n\nexport class SharedStorageEventsView extends UI.SplitWidget.SplitWidget {\n  readonly #sharedStorageEventGrid = new ApplicationComponents.SharedStorageAccessGrid.SharedStorageAccessGrid();\n  #events: Protocol.Storage.SharedStorageAccessedEvent[] = [];\n  #noDisplayView: UI.Widget.VBox;\n  #defaultId: Protocol.Page.FrameId = '' as Protocol.Page.FrameId;\n\n  constructor() {\n    super(/* isVertical */ false, /* secondIsSidebar: */ true);\n\n    this.element.setAttribute('jslog', `${VisualLogging.pane('shared-storage-events')}`);\n\n    const topPanel = new UI.Widget.VBox();\n    this.#noDisplayView = new UI.Widget.VBox();\n\n    topPanel.setMinimumSize(0, 80);\n    this.setMainWidget(topPanel);\n    this.#noDisplayView.setMinimumSize(0, 40);\n    this.setSidebarWidget(this.#noDisplayView);\n\n    topPanel.contentElement.appendChild(this.#sharedStorageEventGrid);\n    this.#sharedStorageEventGrid.addEventListener('cellfocused', this.#onFocus.bind(this));\n    this.#sharedStorageEventGrid.setAttribute('jslog', `${VisualLogging.section('events-table')}`);\n\n    this.#getMainFrameResourceTreeModel()?.addEventListener(\n        SDK.ResourceTreeModel.Events.PrimaryPageChanged, this.clearEvents, this);\n\n    this.#noDisplayView.contentElement.classList.add('placeholder');\n    const noDisplayDiv = this.#noDisplayView.contentElement.createChild('div');\n    noDisplayDiv.textContent = i18nString(UIStrings.clickToDisplayBody);\n  }\n\n  #getMainFrameResourceTreeModel(): SDK.ResourceTreeModel.ResourceTreeModel|null {\n    const primaryPageTarget = SDK.TargetManager.TargetManager.instance().primaryPageTarget();\n    return primaryPageTarget?.model(SDK.ResourceTreeModel.ResourceTreeModel) || null;\n  }\n\n  #getMainFrame(): SDK.ResourceTreeModel.ResourceTreeFrame|null {\n    return this.#getMainFrameResourceTreeModel()?.mainFrame || null;\n  }\n\n  get id(): Protocol.Page.FrameId {\n    return this.#getMainFrame()?.id || this.#defaultId;\n  }\n\n  override wasShown(): void {\n    super.wasShown();\n    const sidebar = this.sidebarWidget();\n    if (sidebar) {\n      sidebar.registerCSSFiles([sharedStorageEventsViewStyles]);\n    }\n  }\n\n  addEvent(event: Protocol.Storage.SharedStorageAccessedEvent): void {\n    // Only add event if main frame id matches.\n    if (event.mainFrameId !== this.id) {\n      return;\n    }\n\n    // Only add if not already present.\n    if (this.#events.some(t => eventEquals(t, event))) {\n      return;\n    }\n\n    this.#events.push(event);\n    this.#sharedStorageEventGrid.data = this.#events;\n  }\n\n  clearEvents(): void {\n    this.#events = [];\n    this.#sharedStorageEventGrid.data = this.#events;\n    this.setSidebarWidget(this.#noDisplayView);\n  }\n\n  async #onFocus(event: Event): Promise<void> {\n    const focusedEvent = event as DataGrid.DataGridEvents.BodyCellFocusedEvent;\n    const row = focusedEvent.data.row;\n    if (!row) {\n      return;\n    }\n\n    const wrappedEvent: WrappedEvent = {\n      accessTime: row.cells.find(cell => cell.columnId === 'event-time')?.value as string,\n      accessType: row.cells.find(cell => cell.columnId === 'event-type')?.value as string,\n      ownerOrigin: row.cells.find(cell => cell.columnId === 'event-owner-origin')?.value as string,\n      eventParams: JSON.parse(row.cells.find(cell => cell.columnId === 'event-params')?.value as string),\n    } as WrappedEvent;\n\n    const jsonView = SourceFrame.JSONView.JSONView.createViewSync(wrappedEvent);\n    jsonView.setMinimumSize(0, 40);\n    this.setSidebarWidget(jsonView);\n  }\n\n  setDefaultIdForTesting(id: Protocol.Page.FrameId): void {\n    this.#defaultId = id;\n  }\n\n  getEventsForTesting(): Array<Protocol.Storage.SharedStorageAccessedEvent> {\n    return this.#events;\n  }\n\n  getSharedStorageAccessGridForTesting(): ApplicationComponents.SharedStorageAccessGrid.SharedStorageAccessGrid {\n    return this.#sharedStorageEventGrid;\n  }\n}\n"]}