{"version":3,"file":"BounceTrackingMitigationsView.js","sourceRoot":"","sources":["../../../../../../../front_end/panels/application/components/BounceTrackingMitigationsView.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2023 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as i18n from '../../../core/i18n/i18n.js';\nimport type * as Platform from '../../../core/platform/platform.js';\nimport * as SDK from '../../../core/sdk/sdk.js';\nimport * as Buttons from '../../../ui/components/buttons/buttons.js';\nimport * as ChromeLink from '../../../ui/components/chrome_link/chrome_link.js';\nimport * as DataGrid from '../../../ui/components/data_grid/data_grid.js';\nimport * as LegacyWrapper from '../../../ui/components/legacy_wrapper/legacy_wrapper.js';\nimport * as ReportView from '../../../ui/components/report_view/report_view.js';\nimport * as LitHtml from '../../../ui/lit-html/lit-html.js';\nimport * as VisualLogging from '../../../ui/visual_logging/visual_logging.js';\n\nimport bounceTrackingMitigationsViewStyles from './bounceTrackingMitigationsView.css.js';\n\nconst UIStrings = {\n  /**\n   * @description Title text in bounce tracking mitigations view of the Application panel.\n   */\n  bounceTrackingMitigationsTitle: 'Bounce tracking mitigations',\n  /**\n   * @description Label for the button to force bounce tracking mitigations to run.\n   */\n  forceRun: 'Force run',\n  /**\n   * @description Label for the disabled button while bounce tracking mitigations are running\n   */\n  runningMitigations: 'Running',\n  /**\n   * @description Heading of table which displays sites whose state was deleted by bounce tracking mitigations.\n   */\n  stateDeletedFor: 'State was deleted for the following sites:',\n  /**\n   * @description Text shown once the deletion command has been sent to the browser process.\n   */\n  checkingPotentialTrackers: 'Checking for potential bounce tracking sites.',\n  /**\n   * @description Link text about explanation of Bounce Tracking Mitigations.\n   */\n  learnMore: 'Learn more: Bounce Tracking Mitigations',\n  /**\n   * @description Text shown when bounce tracking mitigations have been forced to run and\n   * identified no potential bounce tracking sites to delete state for. This may also\n   * indicate that bounce tracking mitigations are disabled or third-party cookies aren't being blocked.\n   */\n  noPotentialBounceTrackersIdentified:\n      'State was not cleared for any potential bounce tracking sites. Either none were identified or third-party cookies are not blocked.',\n  /**\n   * @description Text shown when bounce tracking mitigations bounce tracking mitigations are disabled. Has a link.\n   * @example {Bounce Tracking Mitigations Feature Flag} PH1\n   */\n  featureDisabled:\n      'Bounce tracking mitigations are disabled. To enable them, set the flag at {PH1} to \"Enabled With Deletion\".',\n  /**\n   * @description Text for link to Bounce Tracking Mitigations feature flag entry in the chrome://flags page.\n   */\n  featureFlag: 'Bounce Tracking Mitigations Feature Flag',\n};\n\nconst str_ = i18n.i18n.registerUIStrings('panels/application/components/BounceTrackingMitigationsView.ts', UIStrings);\nexport const i18nString = i18n.i18n.getLocalizedString.bind(undefined, str_);\n\nconst enum ScreenStatusType {\n  Running = 'Running',\n  Result = 'Result',\n  Disabled = 'Disabled',\n}\n\nexport interface BounceTrackingMitigationsViewData {\n  trackingSites: string[];\n}\n\nexport class BounceTrackingMitigationsView extends LegacyWrapper.LegacyWrapper.WrappableComponent {\n  static readonly litTagName = LitHtml.literal`devtools-bounce-tracking-mitigations-view`;\n  readonly #shadow = this.attachShadow({mode: 'open'});\n  #trackingSites: string[] = [];\n  #screenStatus = ScreenStatusType.Result;\n  #checkedFeature = false;\n  #seenButtonClick = false;\n\n  connectedCallback(): void {\n    this.#shadow.adoptedStyleSheets = [bounceTrackingMitigationsViewStyles];\n    void this.#render();\n  }\n\n  async #render(): Promise<void> {\n    // clang-format off\n    LitHtml.render(LitHtml.html`\n      <${ReportView.ReportView.Report.litTagName} .data=${\n          {reportTitle: i18nString(UIStrings.bounceTrackingMitigationsTitle)} as ReportView.ReportView.ReportData\n      }\n      jslog=${VisualLogging.pane('bounce-tracking-mitigations')}>\n        ${await this.#renderMainFrameInformation()}\n      </${ReportView.ReportView.Report.litTagName}>\n    `, this.#shadow, {host: this});\n    // clang-format on\n  }\n\n  async #renderMainFrameInformation(): Promise<LitHtml.TemplateResult> {\n    if (!this.#checkedFeature) {\n      await this.#checkFeatureState();\n    }\n\n    if (this.#screenStatus === ScreenStatusType.Disabled) {\n      const mitigationsFlagLink = new ChromeLink.ChromeLink.ChromeLink();\n      mitigationsFlagLink.href = 'chrome://flags/#bounce-tracking-mitigations' as Platform.DevToolsPath.UrlString;\n      mitigationsFlagLink.textContent = i18nString(UIStrings.featureFlag);\n\n      // clang-format off\n      return LitHtml.html`\n        <${ReportView.ReportView.ReportSection.litTagName}>\n          ${i18n.i18n.getFormatLocalizedString(\n              str_, UIStrings.featureDisabled,\n              {PH1: mitigationsFlagLink})}\n        </${ReportView.ReportView.ReportSection.litTagName}>\n      `;\n      // clang-format on\n    }\n\n    // clang-format off\n    return LitHtml.html`\n      <${ReportView.ReportView.ReportSection.litTagName}>\n        ${this.#renderForceRunButton()}\n      </${ReportView.ReportView.ReportSection.litTagName}>\n        ${this.#renderDeletedSitesOrNoSitesMessage()}\n      <${ReportView.ReportView.ReportSectionDivider.litTagName}>\n      </${ReportView.ReportView.ReportSectionDivider.litTagName}>\n      <${ReportView.ReportView.ReportSection.litTagName}>\n        <x-link href=\"https://privacycg.github.io/nav-tracking-mitigations/#bounce-tracking-mitigations\" class=\"link\"\n        jslog=${VisualLogging.link('learn-more').track({click: true})}>\n          ${i18nString(UIStrings.learnMore)}\n        </x-link>\n      </${ReportView.ReportView.ReportSection.litTagName}>\n    `;\n    // clang-format on\n  }\n\n  #renderForceRunButton(): LitHtml.TemplateResult {\n    const isMitigationRunning = (this.#screenStatus === ScreenStatusType.Running);\n\n    // clang-format off\n    return LitHtml.html`\n      <${Buttons.Button.Button.litTagName}\n        aria-label=${i18nString(UIStrings.forceRun)}\n        .disabled=${isMitigationRunning}\n        .spinner=${isMitigationRunning}\n        .variant=${Buttons.Button.Variant.PRIMARY}\n        @click=${this.#runMitigations}\n        jslog=${VisualLogging.action('force-run').track({click: true})}>\n        ${isMitigationRunning ? LitHtml.html`\n          ${i18nString(UIStrings.runningMitigations)}`:`\n          ${i18nString(UIStrings.forceRun)}\n        `}\n      </${Buttons.Button.Button.litTagName}>\n    `;\n    // clang-format on\n  }\n\n  #renderDeletedSitesOrNoSitesMessage(): LitHtml.TemplateResult {\n    if (!this.#seenButtonClick) {\n      return LitHtml.html``;\n    }\n\n    if (this.#trackingSites.length === 0) {\n      // clang-format off\n      return LitHtml.html`\n        <${ReportView.ReportView.ReportSection.litTagName}>\n        ${(this.#screenStatus === ScreenStatusType.Running) ? LitHtml.html`\n          ${i18nString(UIStrings.checkingPotentialTrackers)}`:`\n          ${i18nString(UIStrings.noPotentialBounceTrackersIdentified)}\n        `}\n        </${ReportView.ReportView.ReportSection.litTagName}>\n      `;\n      // clang-format on\n    }\n\n    const gridData: DataGrid.DataGridController.DataGridControllerData = {\n      columns: [\n        {\n          id: 'sites',\n          title: i18nString(UIStrings.stateDeletedFor),\n          widthWeighting: 10,\n          hideable: false,\n          visible: true,\n          sortable: true,\n        },\n      ],\n      rows: this.#buildRowsFromDeletedSites(),\n      initialSort: {\n        columnId: 'sites',\n        direction: DataGrid.DataGridUtils.SortDirection.ASC,\n      },\n    };\n\n    // clang-format off\n    return LitHtml.html`\n      <${ReportView.ReportView.ReportSection.litTagName}>\n        <${DataGrid.DataGridController.DataGridController.litTagName} .data=${\n            gridData as DataGrid.DataGridController.DataGridControllerData}>\n        </${DataGrid.DataGridController.DataGridController.litTagName}>\n      </${ReportView.ReportView.ReportSection.litTagName}>\n    `;\n    // clang-format on\n  }\n\n  async #runMitigations(): Promise<void> {\n    const mainTarget = SDK.TargetManager.TargetManager.instance().primaryPageTarget();\n    if (!mainTarget) {\n      return;\n    }\n\n    this.#seenButtonClick = true;\n    this.#screenStatus = ScreenStatusType.Running;\n\n    void this.#render();\n\n    const response = await mainTarget.storageAgent().invoke_runBounceTrackingMitigations();\n    this.#trackingSites = [];\n    response.deletedSites.forEach(element => {\n      this.#trackingSites.push(element);\n    });\n\n    this.#renderMitigationsResult();\n  }\n\n  #renderMitigationsResult(): void {\n    this.#screenStatus = ScreenStatusType.Result;\n    void this.#render();\n  }\n\n  #buildRowsFromDeletedSites(): DataGrid.DataGridUtils.Row[] {\n    const trackingSites = this.#trackingSites;\n    return trackingSites.map(site => ({\n                               cells: [\n                                 {columnId: 'sites', value: site},\n                               ],\n                             }));\n  }\n\n  async #checkFeatureState(): Promise<void> {\n    this.#checkedFeature = true;\n\n    const mainTarget = SDK.TargetManager.TargetManager.instance().primaryPageTarget();\n    if (!mainTarget) {\n      return;\n    }\n\n    if (!(await mainTarget.systemInfo().invoke_getFeatureState({featureState: 'DIPS'})).featureEnabled) {\n      this.#screenStatus = ScreenStatusType.Disabled;\n    }\n  }\n}\n\ncustomElements.define('devtools-bounce-tracking-mitigations-view', BounceTrackingMitigationsView);\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'devtools-bounce-tracking-mitigations-view': BounceTrackingMitigationsView;\n  }\n}\n"]}