{"version":3,"file":"FrameDetailsView.test.js","sourceRoot":"","sources":["../../../../../../../front_end/panels/application/components/FrameDetailsView.test.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2021 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as SDK from '../../../core/sdk/sdk.js';\nimport * as Protocol from '../../../generated/protocol.js';\nimport * as Bindings from '../../../models/bindings/bindings.js';\nimport * as Workspace from '../../../models/workspace/workspace.js';\nimport {\n  getCleanTextContentFromElements,\n  getElementsWithinComponent,\n  getElementWithinComponent,\n  renderElementIntoDOM,\n} from '../../../testing/DOMHelpers.js';\nimport {createTarget} from '../../../testing/EnvironmentHelpers.js';\nimport {describeWithMockConnection} from '../../../testing/MockConnection.js';\nimport * as ExpandableList from '../../../ui/components/expandable_list/expandable_list.js';\nimport * as Coordinator from '../../../ui/components/render_coordinator/render_coordinator.js';\nimport * as ReportView from '../../../ui/components/report_view/report_view.js';\n\nimport * as ApplicationComponents from './components.js';\n\nconst coordinator = Coordinator.RenderCoordinator.RenderCoordinator.instance();\n\nconst makeFrame = (target: SDK.Target.Target) => {\n  const newFrame: SDK.ResourceTreeModel.ResourceTreeFrame = {\n    url: 'https://www.example.com/path/page.html',\n    securityOrigin: 'https://www.example.com',\n    displayName: () => 'TestTitle',\n    unreachableUrl: () => '',\n    adFrameType: () => Protocol.Page.AdFrameType.None,\n    adFrameStatus: () => undefined,\n    getAdScriptId: () => '1' as Protocol.Runtime.ScriptId,\n    resourceForURL: () => null,\n    isSecureContext: () => true,\n    isCrossOriginIsolated: () => true,\n    getCrossOriginIsolatedContextType: () => Protocol.Page.CrossOriginIsolatedContextType.NotIsolatedFeatureDisabled,\n    getSecureContextType: () => Protocol.Page.SecureContextType.SecureLocalhost,\n    getGatedAPIFeatures: () =>\n        [Protocol.Page.GatedAPIFeatures.SharedArrayBuffers,\n         Protocol.Page.GatedAPIFeatures.SharedArrayBuffersTransferAllowed],\n    getOwnerDOMNodeOrDocument: () => ({\n      nodeName: () => 'iframe',\n    }),\n    resourceTreeModel: () => target.model(SDK.ResourceTreeModel.ResourceTreeModel),\n    getCreationStackTraceData: () => ({\n      creationStackTrace: {\n        callFrames: [{\n          functionName: 'function1',\n          url: 'http://www.example.com/script.js',\n          lineNumber: 15,\n          columnNumber: 10,\n          scriptId: 'someScriptId',\n        }],\n      },\n      creationStackTraceTarget: null,\n    }),\n    getOriginTrials: async () => ([\n      {\n        trialName: 'AppCache',\n        status: 'Enabled',\n        tokensWithStatus: [{\n          status: 'Success',\n          rawTokenText: 'Text',\n          parsedToken: {\n            trialName: 'AppCache',\n            origin: 'https://foo.com',\n            expiryTime: 1000,\n            usageRestriction: 'None',\n            isThirdParty: false,\n            matchSubDomains: false,\n          },\n        }],\n      },\n    ]),\n    getPermissionsPolicyState: () => null,\n    parentFrame: () => null,\n  } as unknown as SDK.ResourceTreeModel.ResourceTreeFrame;\n  return newFrame;\n};\n\ndescribeWithMockConnection('FrameDetailsView', () => {\n  it('renders with a title', async () => {\n    const frame = makeFrame(createTarget());\n    const component = new ApplicationComponents.FrameDetailsView.FrameDetailsReportView(frame);\n    renderElementIntoDOM(component);\n\n    assert.isNotNull(component.shadowRoot);\n    void component.render();\n    await coordinator.done({waitForWork: true});\n    const report = getElementWithinComponent(component, 'devtools-report', ReportView.ReportView.Report);\n\n    const titleElement = report.shadowRoot!.querySelector('.report-title');\n    assert.strictEqual(titleElement?.textContent, frame.displayName());\n  });\n\n  it('renders report keys and values', async () => {\n    const workspace = Workspace.Workspace.WorkspaceImpl.instance({forceNew: true});\n    const targetManager = SDK.TargetManager.TargetManager.instance();\n    Bindings.DebuggerWorkspaceBinding.DebuggerWorkspaceBinding.instance({\n      forceNew: true,\n      resourceMapping: new Bindings.ResourceMapping.ResourceMapping(targetManager, workspace),\n      targetManager,\n    });\n\n    const target = createTarget();\n    const debuggerModel = target.model(SDK.DebuggerModel.DebuggerModel);\n    assert.exists(debuggerModel);\n    sinon.stub(SDK.DebuggerModel.DebuggerModel, 'modelForDebuggerId').resolves(debuggerModel);\n\n    const frame = makeFrame(target);\n    frame.adFrameType = () => Protocol.Page.AdFrameType.Root;\n    frame.parentFrame = () => ({\n      getAdScriptId: () => ({\n        scriptId: 'scriptId' as Protocol.Runtime.ScriptId,\n        debuggerId: '42' as Protocol.Runtime.UniqueDebuggerId,\n      }),\n    } as unknown as SDK.ResourceTreeModel.ResourceTreeFrame);\n    const networkManager = target.model(SDK.NetworkManager.NetworkManager);\n    assert.exists(networkManager);\n    sinon.stub(networkManager, 'getSecurityIsolationStatus').resolves({\n      coep: {\n        value: Protocol.Network.CrossOriginEmbedderPolicyValue.None,\n        reportOnlyValue: Protocol.Network.CrossOriginEmbedderPolicyValue.None,\n      },\n      coop: {\n        value: Protocol.Network.CrossOriginOpenerPolicyValue.SameOrigin,\n        reportOnlyValue: Protocol.Network.CrossOriginOpenerPolicyValue.SameOrigin,\n      },\n      csp: [{\n        source: Protocol.Network.ContentSecurityPolicySource.HTTP,\n        isEnforced: true,\n        effectiveDirectives:\n            'base-uri \\'self\\'; object-src \\'none\\'; script-src \\'strict-dynamic\\' \\'unsafe-inline\\' https: http: \\'nonce-GsVjHiIoejpPhMPOHDQZ90yc9eJn1s\\' \\'unsafe-eval\\'; report-uri https://www.example.com/csp',\n      }],\n    });\n\n    const component = new ApplicationComponents.FrameDetailsView.FrameDetailsReportView(frame);\n    renderElementIntoDOM(component);\n\n    assert.isNotNull(component.shadowRoot);\n    await component.render();\n    await coordinator.done({waitForWork: true});\n\n    const keys = getCleanTextContentFromElements(component.shadowRoot, 'devtools-report-key');\n    assert.deepEqual(keys, [\n      'URL',\n      'Origin',\n      'Owner Element',\n      'Frame Creation Stack Trace',\n      'Ad Status',\n      'Creator Ad Script',\n      'Secure Context',\n      'Cross-Origin Isolated',\n      'Cross-Origin Embedder Policy (COEP)',\n      'Cross-Origin Opener Policy (COOP)',\n      'Content-Security-Policy',\n      'SharedArrayBuffers',\n      'Measure Memory',\n    ]);\n\n    const values = getCleanTextContentFromElements(component.shadowRoot, 'devtools-report-value');\n    assert.deepEqual(values, [\n      'https://www.example.com/path/page.html',\n      'https://www.example.com',\n      '<iframe>',\n      '',\n      '',\n      '',\n      'Yes\\xA0Localhost is always a secure context',\n      'Yes',\n      'None',\n      'SameOrigin',\n      'HTTP headerbase-uri: \\'self\\'object-src: \\'none\\'script-src: \\'strict-dynamic\\', \\'unsafe-inline\\', https:, http:, \\'nonce-GsVjHiIoejpPhMPOHDQZ90yc9eJn1s\\', \\'unsafe-eval\\'report-uri: https://www.example.com/csp',\n      'available, transferable',\n      'available\\xA0Learn more',\n    ]);\n\n    const stackTrace = getElementWithinComponent(\n        component, 'devtools-resources-stack-trace', ApplicationComponents.StackTrace.StackTrace);\n    assert.isNotNull(stackTrace.shadowRoot);\n    const expandableList =\n        getElementWithinComponent(stackTrace, 'devtools-expandable-list', ExpandableList.ExpandableList.ExpandableList);\n    assert.isNotNull(expandableList.shadowRoot);\n\n    const stackTraceRows = getElementsWithinComponent(\n        expandableList, 'devtools-stack-trace-row', ApplicationComponents.StackTrace.StackTraceRow);\n    let stackTraceText: string[] = [];\n\n    stackTraceRows.forEach(row => {\n      assert.isNotNull(row.shadowRoot);\n      stackTraceText = stackTraceText.concat(getCleanTextContentFromElements(row.shadowRoot, '.stack-trace-row'));\n    });\n\n    assert.deepEqual(stackTraceText[0], 'function1\\xA0@\\xA0www.example.com/script.js:16');\n\n    const adScriptLink = component.shadowRoot.querySelector('devtools-report-value.ad-script-link');\n    assert.exists(adScriptLink);\n    assert.strictEqual(adScriptLink.textContent, '');\n  });\n});\n"]}