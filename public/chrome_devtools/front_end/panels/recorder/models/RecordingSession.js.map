{"version":3,"file":"RecordingSession.js","sourceRoot":"","sources":["../../../../../../../front_end/panels/recorder/models/RecordingSession.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2023 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Common from '../../../core/common/common.js';\nimport * as Platform from '../../../core/platform/platform.js';\nimport * as SDK from '../../../core/sdk/sdk.js';\nimport * as UI from '../../../ui/legacy/legacy.js';\nimport * as Util from '../util/util.js';\n\nimport type * as ProtocolProxyApi from '../../../generated/protocol-proxy-api.js';\nimport type * as Protocol from '../../../generated/protocol.js';\nimport type * as Injected from '../injected/injected.js';\n\nimport {\n  AssertedEventType,\n  StepType,\n  type Key,\n  type ChangeStep,\n  type ClickStep,\n  type DoubleClickStep,\n  type FrameSelector,\n  type KeyDownStep,\n  type KeyUpStep,\n  type NavigationEvent,\n  type SelectorType,\n  type Step,\n  type Target,\n  type UserFlow,\n} from './Schema.js';\nimport {areSelectorsEqual, createEmulateNetworkConditionsStep, createViewportStep} from './SchemaUtils.js';\nimport {evaluateInAllFrames, getTargetFrameContext} from './SDKUtils.js';\n\nconst formatAsJSLiteral = Platform.StringUtilities.formatAsJSLiteral;\n\ntype TargetInfoChangedEvent = {\n  type: 'targetInfoChanged',\n  event: Common.EventTarget.EventTargetEvent<Protocol.Target.TargetInfo>,\n  target: SDK.Target.Target,\n};\n\ntype TargerCreatedRecorderEvent = {\n  type: 'targetCreated',\n  event: Common.EventTarget.EventTargetEvent<Protocol.Target.TargetInfo>,\n  target: SDK.Target.Target,\n};\n\ntype TargetClosedRecorderEvent = {\n  type: 'targetClosed',\n  event: Common.EventTarget.EventTargetEvent<Protocol.Target.TargetID>,\n  target: SDK.Target.Target,\n};\n\ntype BindingCalledRecorderEvent = {\n  type: 'bindingCalled',\n  event: Common.EventTarget.EventTargetEvent<Protocol.Runtime.BindingCalledEvent>,\n  target: SDK.Target.Target,\n  frameId: Protocol.Page.FrameId,\n};\n\ntype RecorderEvent =\n    |TargetInfoChangedEvent|TargerCreatedRecorderEvent|TargetClosedRecorderEvent|BindingCalledRecorderEvent;\n\nconst unrelatedNavigationTypes = new Set([\n  'typed',\n  'address_bar',\n  'auto_bookmark',\n  'auto_subframe',\n  'generated',\n  'auto_toplevel',\n  'reload',\n  'keyword',\n  'keyword_generated',\n]);\n\ninterface Shortcut {\n  meta: boolean;\n  ctrl: boolean;\n  shift: boolean;\n  alt: boolean;\n  keyCode: number;\n}\n\nconst createShortcuts = (descriptors: number[][]): Shortcut[] => {\n  const shortcuts: Shortcut[] = [];\n  for (const shortcut of descriptors) {\n    for (const key of shortcut) {\n      const shortcutBase = {meta: false, ctrl: false, shift: false, alt: false, keyCode: -1};\n\n      const {keyCode, modifiers} = UI.KeyboardShortcut.KeyboardShortcut.keyCodeAndModifiersFromKey(key);\n\n      shortcutBase.keyCode = keyCode;\n      const modifiersMap = UI.KeyboardShortcut.Modifiers;\n\n      shortcutBase.ctrl = Boolean(modifiers & modifiersMap.Ctrl);\n      shortcutBase.meta = Boolean(modifiers & modifiersMap.Meta);\n      shortcutBase.shift = Boolean(modifiers & modifiersMap.Shift);\n      shortcutBase.shift = Boolean(modifiers & modifiersMap.Alt);\n\n      if (shortcutBase.keyCode !== -1) {\n        shortcuts.push(shortcutBase);\n      }\n    }\n  }\n\n  return shortcuts;\n};\n\nconst evaluateInAllTargets =\n    async(worldName: string, targets: SDK.Target.Target[], expression: string): Promise<void> => {\n  await Promise.all(targets.map(target => evaluateInAllFrames(worldName, target, expression)));\n};\n\nconst RecorderBinding = Object.freeze({\n  addStep: 'addStep',\n  stopShortcut: 'stopShortcut',\n});\n\nexport class RecordingSession extends Common.ObjectWrapper.ObjectWrapper<EventTypes> {\n  readonly #target: SDK.Target.Target;\n  readonly #pageAgent: ProtocolProxyApi.PageApi;\n  readonly #targetAgent: ProtocolProxyApi.TargetApi;\n  readonly #networkManager: SDK.NetworkManager.MultitargetNetworkManager;\n  readonly #resourceTreeModel: SDK.ResourceTreeModel.ResourceTreeModel;\n  readonly #targets = new Map<string, SDK.Target.Target>();\n  readonly #lastNavigationEntryIdByTarget = new Map<string, number>();\n  readonly #lastNavigationHistoryByTarget = new Map<string, Array<number>>();\n  readonly #scriptIdentifiers = new Map<string, Protocol.Page.ScriptIdentifier>();\n  readonly #runtimeEventDescriptors = new Map<\n      SDK.Target.Target, Common.EventTarget.EventDescriptor<SDK.RuntimeModel.EventTypes, SDK.RuntimeModel.Events>[]>();\n  readonly #childTargetEventDescriptors = new Map<\n      SDK.Target.Target,\n      Common.EventTarget.EventDescriptor<SDK.ChildTargetManager.EventTypes, SDK.ChildTargetManager.Events>[]>();\n  readonly #mutex = new Common.Mutex.Mutex();\n\n  #userFlow: UserFlow;\n  #stepsPendingNavigationByTargetId: Map<string, Step> = new Map();\n  #started = false;\n  #selectorTypesToRecord: SelectorType[] = [];\n\n  constructor(target: SDK.Target.Target, opts: {\n    title: string,\n    selectorTypesToRecord: SelectorType[],\n    selectorAttribute?: string,\n  }) {\n    super();\n    this.#target = target;\n    this.#pageAgent = target.pageAgent();\n    this.#targetAgent = target.targetAgent();\n    this.#networkManager = SDK.NetworkManager.MultitargetNetworkManager.instance();\n    const resourceTreeModel = target.model(SDK.ResourceTreeModel.ResourceTreeModel);\n    if (!resourceTreeModel) {\n      throw new Error('ResourceTreeModel is missing for the target: ' + target.id());\n    }\n    this.#resourceTreeModel = resourceTreeModel;\n    this.#target = target;\n    this.#userFlow = {title: opts.title, selectorAttribute: opts.selectorAttribute, steps: []};\n    this.#selectorTypesToRecord = opts.selectorTypesToRecord;\n  }\n\n  /**\n   * @returns - A deep copy of the session's current user flow.\n   */\n  cloneUserFlow(): UserFlow {\n    return structuredClone(this.#userFlow);\n  }\n\n  /**\n   * Overwrites the session's current user flow with the given one.\n   *\n   * This method will not dispatch an `recordingupdated` event.\n   */\n  overwriteUserFlow(flow: Readonly<UserFlow>): void {\n    this.#userFlow = structuredClone(flow);\n  }\n\n  async start(): Promise<void> {\n    if (this.#started) {\n      throw new Error('The session has started');\n    }\n    this.#started = true;\n\n    this.#networkManager.addEventListener(\n        SDK.NetworkManager.MultitargetNetworkManager.Events.ConditionsChanged, this.#appendCurrentNetworkStep, this);\n\n    await this.#appendInitialSteps();\n\n    // Focus the target so that events can be captured without additional actions.\n    await this.#pageAgent.invoke_bringToFront();\n\n    await this.#setUpTarget(this.#target);\n  }\n\n  async stop(): Promise<void> {\n    // Wait for any remaining updates.\n    await this.#dispatchRecordingUpdate();\n\n    // Create a deadlock for the remaining events.\n    void this.#mutex.acquire();\n\n    await Promise.all([...this.#targets.values()].map(this.#tearDownTarget));\n\n    this.#networkManager.removeEventListener(\n        SDK.NetworkManager.MultitargetNetworkManager.Events.ConditionsChanged, this.#appendCurrentNetworkStep, this);\n  }\n\n  async #appendInitialSteps(): Promise<void> {\n    // Quick validation before doing anything.\n    const mainFrame = this.#resourceTreeModel.mainFrame;\n    if (!mainFrame) {\n      throw new Error('Could not find mainFrame.');\n    }\n\n    // Network step.\n    if (this.#networkManager.networkConditions() !== SDK.NetworkManager.NoThrottlingConditions) {\n      this.#appendCurrentNetworkStep();\n    }\n\n    // Viewport step.\n    const {cssLayoutViewport} = await this.#target.pageAgent().invoke_getLayoutMetrics();\n    this.#appendStep(createViewportStep(cssLayoutViewport));\n\n    // Navigation step.\n    const history = await this.#resourceTreeModel.navigationHistory();\n    if (history) {\n      const entry = history.entries[history.currentIndex];\n      this.#lastNavigationEntryIdByTarget.set(this.#target.id(), entry.id);\n      this.#lastNavigationHistoryByTarget.set(this.#target.id(), history.entries.map(entry => entry.id));\n      this.#userFlow.steps.push({\n        type: StepType.Navigate,\n        url: entry.url,\n        assertedEvents: [{type: AssertedEventType.Navigation, url: entry.url, title: entry.title}],\n      });\n    } else {\n      this.#userFlow.steps.push({\n        type: StepType.Navigate,\n        url: mainFrame.url,\n        assertedEvents: [\n          {type: AssertedEventType.Navigation, url: mainFrame.url, title: await this.#getDocumentTitle(this.#target)},\n        ],\n      });\n    }\n\n    // Commit\n    void this.#dispatchRecordingUpdate();\n  }\n\n  async #getDocumentTitle(target: SDK.Target.Target): Promise<string> {\n    const response = await target.runtimeAgent().invoke_evaluate({expression: 'document.title'});\n    return response.result?.value || '';\n  }\n\n  #appendCurrentNetworkStep(): void {\n    const networkConditions = this.#networkManager.networkConditions();\n    this.#appendStep(createEmulateNetworkConditionsStep(networkConditions));\n  }\n\n  #updateTimeout?: number;\n  #updateListeners: Array<() => void> = [];\n  #dispatchRecordingUpdate(): Promise<void> {\n    if (this.#updateTimeout) {\n      clearTimeout(this.#updateTimeout);\n    }\n    this.#updateTimeout = setTimeout(() => {\n                            // Making a copy to prevent mutations of this.userFlow by event consumers.\n                            this.dispatchEventToListeners(Events.RecordingUpdated, structuredClone(this.#userFlow));\n                            this.#updateTimeout = undefined;\n                            for (const resolve of this.#updateListeners) {\n                              resolve();\n                            }\n                            this.#updateListeners.length = 0;\n                          }, 100) as unknown as number;\n    return new Promise<void>(resolve => {\n      this.#updateListeners.push(resolve);\n    });\n  }\n\n  get #previousStep(): Step|undefined {\n    return this.#userFlow.steps.slice(-1)[0];\n  }\n\n  /**\n   * Contains keys that are pressed related to a change step.\n   */\n  #pressedChangeKeys = new Set<Key>();\n\n  /**\n   * Shift-reduces a given step into the user flow.\n   */\n  #appendStep(step: Step): void {\n    switch (step.type) {\n      case 'doubleClick': {\n        for (let j = this.#userFlow.steps.length - 1; j > 0; j--) {\n          const previousStep = this.#userFlow.steps[j];\n          if (previousStep.type === 'click') {\n            step.selectors = previousStep.selectors;\n            this.#userFlow.steps.splice(j, 1);\n            break;\n          }\n        }\n        break;\n      }\n      case 'change': {\n        const previousStep = this.#previousStep;\n        if (!previousStep) {\n          break;\n        }\n        switch (previousStep.type) {\n          // Merging changes.\n          case 'change':\n            if (!areSelectorsEqual(step, previousStep)) {\n              break;\n            }\n            this.#userFlow.steps[this.#userFlow.steps.length - 1] = step;\n            void this.#dispatchRecordingUpdate();\n            return;\n          // Ignore key downs resulting in inputs.\n          case 'keyDown':\n            this.#pressedChangeKeys.add(previousStep.key);\n            this.#userFlow.steps.pop();\n            this.#appendStep(step);\n            return;\n        }\n        break;\n      }\n      case 'keyDown': {\n        // This can happen if there are successive keydown's from a repeated key\n        // for example.\n        if (this.#pressedChangeKeys.has(step.key)) {\n          return;\n        }\n        break;\n      }\n      case 'keyUp': {\n        // Ignore key ups coming from change inputs.\n        if (this.#pressedChangeKeys.has(step.key)) {\n          this.#pressedChangeKeys.delete(step.key);\n          return;\n        }\n        break;\n      }\n    }\n    this.#userFlow.steps.push(step);\n    void this.#dispatchRecordingUpdate();\n  }\n\n  #handleBeforeUnload(context: {frame: FrameSelector, target: Target}, sdkTarget: SDK.Target.Target): void {\n    const lastStep = this.#userFlow.steps[this.#userFlow.steps.length - 1];\n    if (lastStep && !lastStep.assertedEvents?.find(event => event.type === AssertedEventType.Navigation)) {\n      const target = context.target || 'main';\n      const frameSelector = (context.frame || []).join(',');\n      const lastStepTarget = lastStep.target || 'main';\n      const lastStepFrameSelector = (('frame' in lastStep ? lastStep.frame : []) || []).join(',');\n      if (target === lastStepTarget && frameSelector === lastStepFrameSelector) {\n        lastStep.assertedEvents = [{type: AssertedEventType.Navigation}];\n        this.#stepsPendingNavigationByTargetId.set(sdkTarget.id(), lastStep);\n        void this.#dispatchRecordingUpdate();\n      }\n    }\n  }\n\n  #replaceUnloadWithNavigation(target: SDK.Target.Target, event: NavigationEvent): void {\n    const stepPendingNavigation = this.#stepsPendingNavigationByTargetId.get(target.id());\n    if (!stepPendingNavigation) {\n      return;\n    }\n    const step = stepPendingNavigation;\n    if (!step.assertedEvents) {\n      return;\n    }\n    const navigationEvent = step.assertedEvents.find(event => event.type === AssertedEventType.Navigation);\n    if (!navigationEvent || navigationEvent.url) {\n      return;\n    }\n    navigationEvent.url = event.url;\n    navigationEvent.title = event.title;\n    void this.#dispatchRecordingUpdate();\n  }\n\n  #handleStopShortcutBinding(event: Common.EventTarget.EventTargetEvent<Protocol.Runtime.BindingCalledEvent>): void {\n    const shortcutLength = Number(event.data.payload);\n    // Look for one less step as the last one gets consumed before creating a step\n    for (let index = 0; index < shortcutLength - 1; index++) {\n      this.#userFlow.steps.pop();\n    }\n\n    this.dispatchEventToListeners(Events.RecordingStopped, structuredClone(this.#userFlow));\n  }\n\n  #receiveBindingCalled(\n      target: SDK.Target.Target,\n      event: Common.EventTarget.EventTargetEvent<Protocol.Runtime.BindingCalledEvent>): void {\n    switch (event.data.name) {\n      case RecorderBinding.stopShortcut:\n        this.#handleStopShortcutBinding(event);\n        return;\n      case RecorderBinding.addStep:\n        this.#handleAddStepBinding(target, event);\n        return;\n      default:\n        return;\n    }\n  }\n\n  #handleAddStepBinding(\n      target: SDK.Target.Target,\n      event: Common.EventTarget.EventTargetEvent<Protocol.Runtime.BindingCalledEvent>): void {\n    const executionContextId = event.data.executionContextId;\n    let frameId: Protocol.Page.FrameId|undefined;\n    const runtimeModel = target.model(SDK.RuntimeModel.RuntimeModel);\n    if (runtimeModel) {\n      for (const context of runtimeModel.executionContexts()) {\n        if (context.id === executionContextId) {\n          frameId = context.frameId;\n          break;\n        }\n      }\n    }\n    if (!frameId) {\n      throw new Error('No execution context found for the binding call + ' + JSON.stringify(event.data));\n    }\n\n    const step = JSON.parse(event.data.payload) as Injected.Step.Step;\n    const resourceTreeModel =\n        target.model(SDK.ResourceTreeModel.ResourceTreeModel) as SDK.ResourceTreeModel.ResourceTreeModel;\n    const frame = resourceTreeModel.frameForId(frameId);\n    if (!frame) {\n      throw new Error('Could not find frame.');\n    }\n\n    const context = getTargetFrameContext(target, frame);\n\n    if (step.type === 'beforeUnload') {\n      this.#handleBeforeUnload(context, target);\n      return;\n    }\n\n    // TODO: type-safe parsing from client steps to internal step format.\n    switch (step.type) {\n      case 'change': {\n        this.#appendStep({\n          type: 'change',\n          value: step.value,\n          selectors: step.selectors,\n          frame: context.frame.length ? context.frame : undefined,\n          target: context.target,\n        } as ChangeStep);\n        break;\n      }\n      case 'doubleClick': {\n        this.#appendStep({\n          type: 'doubleClick',\n          target: context.target,\n          selectors: step.selectors,\n          offsetY: step.offsetY,\n          offsetX: step.offsetX,\n          frame: context.frame.length ? context.frame : undefined,\n          deviceType: step.deviceType,\n          button: step.button,\n        } as DoubleClickStep);\n        break;\n      }\n      case 'click': {\n        this.#appendStep({\n          type: 'click',\n          target: context.target,\n          selectors: step.selectors,\n          offsetY: step.offsetY,\n          offsetX: step.offsetX,\n          frame: context.frame.length ? context.frame : undefined,\n          duration: step.duration,\n          deviceType: step.deviceType,\n          button: step.button,\n        } as ClickStep);\n        break;\n      }\n      case 'keyUp': {\n        this.#appendStep({\n          type: 'keyUp',\n          key: step.key,\n          frame: context.frame.length ? context.frame : undefined,\n          target: context.target,\n        } as KeyUpStep);\n        break;\n      }\n      case 'keyDown': {\n        this.#appendStep({\n          type: 'keyDown',\n          frame: context.frame.length ? context.frame : undefined,\n          target: context.target,\n          key: step.key,\n        } as KeyDownStep);\n        break;\n      }\n      default:\n        throw new Error('Unhandled client event');\n    }\n  }\n\n  #getStopShortcuts(): Shortcut[] {\n    const descriptors = UI.ShortcutRegistry.ShortcutRegistry.instance()\n                            .shortcutsForAction('chrome-recorder.start-recording')\n                            .map(key => key.descriptors.map(press => press.key));\n\n    return createShortcuts(descriptors);\n  }\n\n  static get #allowUntrustedEvents(): boolean {\n    try {\n      // This setting is set during the test to work around the fact that Puppeteer cannot\n      // send trusted change and input events.\n      Common.Settings.Settings.instance().settingForTest('untrusted-recorder-events');\n      return true;\n    } catch {\n    }\n    return false;\n  }\n\n  #setUpTarget = async(target: SDK.Target.Target): Promise<void> => {\n    if (target.type() !== SDK.Target.Type.Frame) {\n      return;\n    }\n    this.#targets.set(target.id(), target);\n\n    const a11yModel = target.model(SDK.AccessibilityModel.AccessibilityModel);\n    Platform.assertNotNullOrUndefined(a11yModel);\n    await a11yModel.resumeModel();\n\n    await this.#addBindings(target);\n    await this.#injectApplicationScript(target);\n\n    const childTargetManager = target.model(SDK.ChildTargetManager.ChildTargetManager);\n    Platform.assertNotNullOrUndefined(childTargetManager);\n    this.#childTargetEventDescriptors.set(target, [\n      childTargetManager.addEventListener(\n          SDK.ChildTargetManager.Events.TargetCreated, this.#receiveTargetCreated.bind(this, target)),\n      childTargetManager.addEventListener(\n          SDK.ChildTargetManager.Events.TargetDestroyed, this.#receiveTargetClosed.bind(this, target)),\n      childTargetManager.addEventListener(\n          SDK.ChildTargetManager.Events.TargetInfoChanged, this.#receiveTargetInfoChanged.bind(this, target)),\n    ]);\n\n    await Promise.all(childTargetManager.childTargets().map(this.#setUpTarget));\n  };\n\n  #tearDownTarget = async(target: SDK.Target.Target): Promise<void> => {\n    const descriptors = this.#childTargetEventDescriptors.get(target);\n    if (descriptors) {\n      Common.EventTarget.removeEventListeners(descriptors);\n    }\n\n    await this.#injectCleanUpScript(target);\n    await this.#removeBindings(target);\n  };\n\n  async #addBindings(target: SDK.Target.Target): Promise<void> {\n    const runtimeModel = target.model(SDK.RuntimeModel.RuntimeModel);\n    Platform.assertNotNullOrUndefined(runtimeModel);\n\n    this.#runtimeEventDescriptors.set(\n        target, [runtimeModel.addEventListener(\n                    SDK.RuntimeModel.Events.BindingCalled, this.#receiveBindingCalled.bind(this, target))]);\n\n    await Promise.all(\n        Object.values(RecorderBinding)\n            .map(name => runtimeModel.addBinding({name, executionContextName: Util.DEVTOOLS_RECORDER_WORLD_NAME})));\n  }\n\n  async #removeBindings(target: SDK.Target.Target): Promise<void> {\n    await Promise.all(Object.values(RecorderBinding).map(name => target.runtimeAgent().invoke_removeBinding({name})));\n\n    const descriptors = this.#runtimeEventDescriptors.get(target);\n    if (descriptors) {\n      Common.EventTarget.removeEventListeners(descriptors);\n    }\n  }\n\n  async #injectApplicationScript(target: SDK.Target.Target): Promise<void> {\n    const injectedScript = await Util.InjectedScript.get();\n    const script = `\n      ${injectedScript};DevToolsRecorder.startRecording({getAccessibleName, getAccessibleRole}, {\n        debug: ${Util.isDebugBuild},\n        allowUntrustedEvents: ${RecordingSession.#allowUntrustedEvents},\n        selectorTypesToRecord: ${JSON.stringify(this.#selectorTypesToRecord)},\n        selectorAttribute: ${\n        this.#userFlow.selectorAttribute ? formatAsJSLiteral(this.#userFlow.selectorAttribute) : undefined},\n        stopShortcuts: ${JSON.stringify(this.#getStopShortcuts())},\n      });\n    `;\n    const [{identifier}] = await Promise.all([\n      target.pageAgent().invoke_addScriptToEvaluateOnNewDocument(\n          {source: script, worldName: Util.DEVTOOLS_RECORDER_WORLD_NAME, includeCommandLineAPI: true}),\n      evaluateInAllFrames(Util.DEVTOOLS_RECORDER_WORLD_NAME, target, script),\n    ]);\n    this.#scriptIdentifiers.set(target.id(), identifier);\n  }\n\n  async #injectCleanUpScript(target: SDK.Target.Target): Promise<void> {\n    const scriptId = this.#scriptIdentifiers.get(target.id());\n    if (!scriptId) {\n      return;\n    }\n    await target.pageAgent().invoke_removeScriptToEvaluateOnNewDocument({identifier: scriptId});\n    await evaluateInAllTargets(\n        Util.DEVTOOLS_RECORDER_WORLD_NAME, [...this.#targets.values()], 'DevToolsRecorder.stopRecording()');\n  }\n\n  #receiveTargetCreated(\n      target: SDK.Target.Target, event: Common.EventTarget.EventTargetEvent<Protocol.Target.TargetInfo>): void {\n    void this.#handleEvent({type: 'targetCreated', event, target});\n  }\n\n  #receiveTargetClosed(\n      eventTarget: SDK.Target.Target, event: Common.EventTarget.EventTargetEvent<Protocol.Target.TargetID>): void {\n    // TODO(alexrudenko): target here appears to be the parent target of the target that is closed.\n    // Therefore, we need to find the real target via the targets map.\n    const childTarget = this.#targets.get(event.data);\n    if (childTarget) {\n      void this.#handleEvent({type: 'targetClosed', event, target: childTarget});\n    }\n  }\n\n  #receiveTargetInfoChanged(\n      eventTarget: SDK.Target.Target, event: Common.EventTarget.EventTargetEvent<Protocol.Target.TargetInfo>): void {\n    const target = this.#targets.get(event.data.targetId) || eventTarget;\n    void this.#handleEvent({type: 'targetInfoChanged', event, target});\n  }\n\n  #handleEvent(event: RecorderEvent): Promise<void> {\n    return this.#mutex.run(async () => {\n      try {\n        if (Util.isDebugBuild) {\n          console.time(`Processing ${JSON.stringify(event)}`);\n        }\n        switch (event.type) {\n          case 'targetClosed':\n            await this.#handleTargetClosed(event);\n            break;\n          case 'targetCreated':\n            await this.#handleTargetCreated(event);\n            break;\n          case 'targetInfoChanged':\n            await this.#handleTargetInfoChanged(event);\n            break;\n        }\n        if (Util.isDebugBuild) {\n          console.timeEnd(`Processing ${JSON.stringify(event)}`);\n        }\n      } catch (err) {\n        console.error('Error happened while processing recording events: ', err.message, err.stack);\n      }\n    });\n  }\n\n  async #handleTargetCreated(event: TargerCreatedRecorderEvent): Promise<void> {\n    if (event.event.data.type !== 'page' && event.event.data.type !== 'iframe') {\n      return;\n    }\n\n    await this.#targetAgent.invoke_attachToTarget({targetId: event.event.data.targetId, flatten: true});\n    const target = SDK.TargetManager.TargetManager.instance().targets().find(t => t.id() === event.event.data.targetId);\n\n    if (!target) {\n      throw new Error('Could not find target.');\n    }\n    // Generally an new target implies all other targets are not waiting for something special in their event buffers, so we flush them here.\n    await this.#setUpTarget(target);\n    // Emitted for e2e tests.\n    window.dispatchEvent(new Event('recorderAttachedToTarget'));\n  }\n\n  async #handleTargetClosed(event: TargetClosedRecorderEvent): Promise<void> {\n    const stepPendingNavigation = this.#stepsPendingNavigationByTargetId.get(event.target.id());\n    if (stepPendingNavigation) {\n      delete stepPendingNavigation.assertedEvents;\n      this.#stepsPendingNavigationByTargetId.delete(event.target.id());\n    }\n    // TODO(alexrudenko): figure out how this works with sections\n    // TODO(alexrudenko): Ignore close events as they only matter for popups but cause more trouble than benefits\n    // const closeStep: CloseStep = {\n    //   type: 'close',\n    //   target: getTargetName(event.target),\n    // };\n    // this.appendStep(closeStep);\n  }\n\n  async #handlePageNavigation(resourceTreeModel: SDK.ResourceTreeModel.ResourceTreeModel, target: SDK.Target.Target):\n      Promise<boolean> {\n    const history = await resourceTreeModel.navigationHistory();\n    if (!history) {\n      return false;\n    }\n    const entry = history.entries[history.currentIndex];\n    const prevId = this.#lastNavigationEntryIdByTarget.get(target.id());\n    if (prevId === entry.id) {\n      return true;\n    }\n    this.#lastNavigationEntryIdByTarget.set(target.id(), entry.id);\n    const lastHistory = this.#lastNavigationHistoryByTarget.get(target.id()) || [];\n    this.#lastNavigationHistoryByTarget.set(target.id(), history.entries.map(entry => entry.id));\n    if (unrelatedNavigationTypes.has(entry.transitionType) || lastHistory.includes(entry.id)) {\n      const stepPendingNavigation = this.#stepsPendingNavigationByTargetId.get(target.id());\n      if (stepPendingNavigation) {\n        delete stepPendingNavigation.assertedEvents;\n        this.#stepsPendingNavigationByTargetId.delete(target.id());\n      }\n      this.#appendStep({\n        type: StepType.Navigate,\n        url: entry.url,\n        assertedEvents: [{type: AssertedEventType.Navigation, url: entry.url, title: entry.title}],\n      });\n    } else {\n      this.#replaceUnloadWithNavigation(\n          target, {type: AssertedEventType.Navigation, url: entry.url, title: entry.title});\n    }\n    return true;\n  }\n\n  async #handleTargetInfoChanged(event: TargetInfoChangedEvent): Promise<void> {\n    if (event.event.data.type !== 'page' && event.event.data.type !== 'iframe') {\n      return;\n    }\n\n    const target = event.target;\n    const resourceTreeModel = target.model(SDK.ResourceTreeModel.ResourceTreeModel);\n    if (!resourceTreeModel) {\n      throw new Error('ResourceTreeModel is missing in handleNavigation');\n    }\n\n    if (event.event.data.type === 'iframe') {\n      this.#replaceUnloadWithNavigation(\n          target,\n          {type: AssertedEventType.Navigation, url: event.event.data.url, title: await this.#getDocumentTitle(target)});\n    } else if (event.event.data.type === 'page') {\n      if (await this.#handlePageNavigation(resourceTreeModel, target)) {\n        return;\n      }\n      // Needed for #getDocumentTitle to return something meaningful.\n      await this.#waitForDOMContentLoadedWithTimeout(resourceTreeModel, 500);\n      this.#replaceUnloadWithNavigation(\n          target,\n          {type: AssertedEventType.Navigation, url: event.event.data.url, title: await this.#getDocumentTitle(target)});\n    }\n  }\n\n  async #waitForDOMContentLoadedWithTimeout(\n      resourceTreeModel: SDK.ResourceTreeModel.ResourceTreeModel, timeout: number): Promise<void> {\n    let resolver: (value: void|Promise<void>) => void = () => Promise.resolve();\n    const contentLoadedPromise = new Promise<void>(resolve => {\n      resolver = resolve;\n    });\n    const onDomContentLoaded = (): void => {\n      resourceTreeModel.removeEventListener(SDK.ResourceTreeModel.Events.DOMContentLoaded, onDomContentLoaded);\n      resolver();\n    };\n    resourceTreeModel.addEventListener(SDK.ResourceTreeModel.Events.DOMContentLoaded, onDomContentLoaded);\n    await Promise.any([\n      contentLoadedPromise,\n      new Promise<void>(\n          resolve => setTimeout(\n              () => {\n                resourceTreeModel.removeEventListener(\n                    SDK.ResourceTreeModel.Events.DOMContentLoaded, onDomContentLoaded);\n                resolve();\n              },\n              timeout)),\n    ]);\n  }\n}\n\nexport const enum Events {\n  RecordingUpdated = 'recordingupdated',\n  RecordingStopped = 'recordingstopped',\n}\n\ntype EventTypes = {\n  [Events.RecordingUpdated]: UserFlow,\n  [Events.RecordingStopped]: UserFlow,\n};\n"]}