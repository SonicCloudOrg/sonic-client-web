{"version":3,"file":"SelectorPicker.js","sourceRoot":"","sources":["../../../../../../../front_end/panels/recorder/controllers/SelectorPicker.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2023 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Common from '../../../core/common/common.js';\nimport * as Platform from '../../../core/platform/platform.js';\nimport * as SDK from '../../../core/sdk/sdk.js';\nimport type * as Protocol from '../../../generated/protocol.js';\nimport type * as LitHtml from '../../../ui/lit-html/lit-html.js';\nimport * as Models from '../models/models.js';\n\nimport * as Util from '../util/util.js';\n\nconst BINDING_NAME = 'captureSelectors';\n\nexport class SelectorPickedEvent extends Event {\n  static readonly eventName = 'selectorpicked';\n  data: Models.Schema.StepWithSelectors&Pick<Models.Schema.ClickAttributes, 'offsetX'|'offsetY'>;\n\n  constructor(\n      data: Models.Schema.StepWithSelectors&Pick<Models.Schema.ClickAttributes, 'offsetX'|'offsetY'>,\n  ) {\n    super(SelectorPickedEvent.eventName, {bubbles: true, composed: true});\n    this.data = data;\n  }\n}\n\nexport class RequestSelectorAttributeEvent extends Event {\n  static readonly eventName = 'requestselectorattribute';\n  send: (attribute?: string) => void;\n\n  constructor(send: (attribute?: string) => void) {\n    super(RequestSelectorAttributeEvent.eventName, {\n      bubbles: true,\n      composed: true,\n    });\n    this.send = send;\n  }\n}\n\nexport class SelectorPicker implements SDK.TargetManager.Observer {\n  static get #targetManager(): SDK.TargetManager.TargetManager {\n    return SDK.TargetManager.TargetManager.instance();\n  }\n\n  readonly #element: LitHtml.LitElement;\n\n  #selectorAttribute?: string;\n\n  readonly #activeMutex = new Common.Mutex.Mutex();\n  active = false;\n\n  constructor(element: LitHtml.LitElement) {\n    this.#element = element;\n  }\n\n  start = (): Promise<void> => {\n    return this.#activeMutex.run(async () => {\n      if (this.active) {\n        return;\n      }\n      this.active = true;\n\n      this.#selectorAttribute = await new Promise<string|undefined>(\n          (resolve, reject) => {\n            const timeout = setTimeout(reject, 1000);\n            this.#element.dispatchEvent(\n                new RequestSelectorAttributeEvent(attribute => {\n                  clearTimeout(timeout);\n                  resolve(attribute);\n                }),\n            );\n          },\n      );\n\n      SelectorPicker.#targetManager.observeTargets(this);\n\n      this.#element.requestUpdate();\n    });\n  };\n\n  stop = (): Promise<void> => {\n    return this.#activeMutex.run(async () => {\n      if (!this.active) {\n        return;\n      }\n      this.active = false;\n\n      SelectorPicker.#targetManager.unobserveTargets(this);\n      SelectorPicker.#targetManager.targets().map(this.targetRemoved.bind(this));\n\n      this.#selectorAttribute = undefined;\n\n      this.#element.requestUpdate();\n    });\n  };\n\n  toggle = (): Promise<void> => {\n    if (!this.active) {\n      return this.start();\n    }\n    return this.stop();\n  };\n\n  readonly #targetMutexes = new Map<SDK.Target.Target, Common.Mutex.Mutex>();\n  targetAdded(target: SDK.Target.Target): void {\n    if (target.type() !== SDK.Target.Type.Frame) {\n      return;\n    }\n    let mutex = this.#targetMutexes.get(target);\n    if (!mutex) {\n      mutex = new Common.Mutex.Mutex();\n      this.#targetMutexes.set(target, mutex);\n    }\n    void mutex.run(async () => {\n      await this.#addBindings(target);\n      await this.#injectApplicationScript(target);\n    });\n  }\n  targetRemoved(target: SDK.Target.Target): void {\n    const mutex = this.#targetMutexes.get(target);\n    if (!mutex) {\n      return;\n    }\n    void mutex.run(async () => {\n      try {\n        await this.#injectCleanupScript(target);\n        await this.#removeBindings(target);\n      } catch {\n      }\n    });\n  }\n\n  #handleBindingCalledEvent = (\n      event: Common.EventTarget.EventTargetEvent<Protocol.Runtime.BindingCalledEvent>,\n      ): void => {\n    if (event.data.name !== BINDING_NAME) {\n      return;\n    }\n    const contextId = event.data.executionContextId;\n    const frames = SDK.TargetManager.TargetManager.instance().targets();\n    const contextTarget = Models.SDKUtils.findTargetByExecutionContext(\n        frames,\n        contextId,\n    );\n    const frameId = Models.SDKUtils.findFrameIdByExecutionContext(\n        frames,\n        contextId,\n    );\n    if (!contextTarget || !frameId) {\n      throw new Error(\n          `No execution context found for the binding call + ${\n              JSON.stringify(\n                  event.data,\n                  )}`,\n      );\n    }\n    const model = contextTarget.model(SDK.ResourceTreeModel.ResourceTreeModel);\n    if (!model) {\n      throw new Error(\n          `ResourceTreeModel instance is missing for the target: ${contextTarget.id()}`,\n      );\n    }\n    const frame = model.frameForId(frameId);\n    if (!frame) {\n      throw new Error('Frame is not found');\n    }\n    this.#element.dispatchEvent(\n        new SelectorPickedEvent({\n          ...JSON.parse(event.data.payload),\n          ...Models.SDKUtils.getTargetFrameContext(contextTarget, frame),\n        }),\n    );\n    void this.stop();\n  };\n\n  readonly #scriptIdentifier = new Map<SDK.Target.Target, Protocol.Page.ScriptIdentifier>();\n  async #injectApplicationScript(target: SDK.Target.Target): Promise<void> {\n    const injectedScript = await Util.InjectedScript.get();\n    const script = `${injectedScript};DevToolsRecorder.startSelectorPicker({getAccessibleName, getAccessibleRole}, ${\n        JSON.stringify(this.#selectorAttribute ? this.#selectorAttribute : undefined)}, ${Util.isDebugBuild})`;\n    const [{identifier}] = await Promise.all([\n      target.pageAgent().invoke_addScriptToEvaluateOnNewDocument({\n        source: script,\n        worldName: Util.DEVTOOLS_RECORDER_WORLD_NAME,\n        includeCommandLineAPI: true,\n      }),\n      Models.SDKUtils.evaluateInAllFrames(Util.DEVTOOLS_RECORDER_WORLD_NAME, target, script),\n    ]);\n    this.#scriptIdentifier.set(target, identifier);\n  }\n  async #injectCleanupScript(target: SDK.Target.Target): Promise<void> {\n    const identifier = this.#scriptIdentifier.get(target);\n    Platform.assertNotNullOrUndefined(identifier);\n    this.#scriptIdentifier.delete(target);\n    await target.pageAgent().invoke_removeScriptToEvaluateOnNewDocument({identifier});\n    const script = 'DevToolsRecorder.stopSelectorPicker()';\n    await Models.SDKUtils.evaluateInAllFrames(Util.DEVTOOLS_RECORDER_WORLD_NAME, target, script);\n  }\n\n  async #addBindings(target: SDK.Target.Target): Promise<void> {\n    const model = target.model(SDK.RuntimeModel.RuntimeModel);\n    Platform.assertNotNullOrUndefined(model);\n    model.addEventListener(SDK.RuntimeModel.Events.BindingCalled, this.#handleBindingCalledEvent);\n    await model.addBinding({\n      name: BINDING_NAME,\n      executionContextName: Util.DEVTOOLS_RECORDER_WORLD_NAME,\n    });\n  }\n  async #removeBindings(target: SDK.Target.Target): Promise<void> {\n    await target.runtimeAgent().invoke_removeBinding({name: BINDING_NAME});\n    const model = target.model(SDK.RuntimeModel.RuntimeModel);\n    Platform.assertNotNullOrUndefined(model);\n    model.removeEventListener(SDK.RuntimeModel.Events.BindingCalled, this.#handleBindingCalledEvent);\n  }\n}\n"]}