{"version":3,"file":"SourceMapManager.js","sourceRoot":"","sources":["../../../../../../front_end/core/sdk/SourceMapManager.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2017 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Common from '../common/common.js';\nimport * as Platform from '../platform/platform.js';\n\nimport {type FrameAssociated} from './FrameAssociated.js';\n\nimport {Type, type Target} from './Target.js';\nimport {Events as TargetManagerEvents, TargetManager} from './TargetManager.js';\n\nimport {PageResourceLoader, type PageResourceLoadInitiator} from './PageResourceLoader.js';\n\nimport {parseSourceMap, SourceMap, type SourceMapV3} from './SourceMap.js';\n\nexport class SourceMapManager<T extends FrameAssociated> extends Common.ObjectWrapper.ObjectWrapper<EventTypes<T>> {\n  readonly #target: Target;\n  #isEnabled: boolean;\n  readonly #clientData: Map<T, ClientData>;\n  readonly #sourceMaps: Map<SourceMap, T>;\n  #attachingClient: T|null;\n\n  constructor(target: Target) {\n    super();\n\n    this.#target = target;\n    this.#isEnabled = true;\n    this.#attachingClient = null;\n    this.#clientData = new Map();\n    this.#sourceMaps = new Map();\n\n    TargetManager.instance().addEventListener(TargetManagerEvents.InspectedURLChanged, this.inspectedURLChanged, this);\n  }\n\n  setEnabled(isEnabled: boolean): void {\n    if (isEnabled === this.#isEnabled) {\n      return;\n    }\n\n    // We need this copy, because `this.#clientData` is getting modified\n    // in the loop body and trying to iterate over it at the same time\n    // leads to an infinite loop.\n    const clientData = [...this.#clientData.entries()];\n    for (const [client] of clientData) {\n      this.detachSourceMap(client);\n    }\n    this.#isEnabled = isEnabled;\n    for (const [client, {relativeSourceURL, relativeSourceMapURL}] of clientData) {\n      this.attachSourceMap(client, relativeSourceURL, relativeSourceMapURL);\n    }\n  }\n\n  private static getBaseUrl(target: Target|null): Platform.DevToolsPath.UrlString {\n    while (target && target.type() !== Type.Frame) {\n      target = target.parentTarget();\n    }\n    return target?.inspectedURL() ?? Platform.DevToolsPath.EmptyUrlString;\n  }\n\n  static resolveRelativeSourceURL(target: Target|null, url: Platform.DevToolsPath.UrlString):\n      Platform.DevToolsPath.UrlString {\n    url = Common.ParsedURL.ParsedURL.completeURL(SourceMapManager.getBaseUrl(target), url) ?? url;\n    return url;\n  }\n\n  private inspectedURLChanged(event: Common.EventTarget.EventTargetEvent<Target>): void {\n    if (event.data !== this.#target) {\n      return;\n    }\n\n    // We need this copy, because `this.#clientData` is getting modified\n    // in the loop body and trying to iterate over it at the same time\n    // leads to an infinite loop.\n    const clientData = [...this.#clientData.entries()];\n    for (const [client, {relativeSourceURL, relativeSourceMapURL}] of clientData) {\n      this.detachSourceMap(client);\n      this.attachSourceMap(client, relativeSourceURL, relativeSourceMapURL);\n    }\n  }\n\n  sourceMapForClient(client: T): SourceMap|undefined {\n    return this.#clientData.get(client)?.sourceMap;\n  }\n\n  // This method actively awaits the source map, if still loading.\n  sourceMapForClientPromise(client: T): Promise<SourceMap|undefined> {\n    const clientData = this.#clientData.get(client);\n    if (!clientData) {\n      return Promise.resolve(undefined);\n    }\n\n    return clientData.sourceMapPromise;\n  }\n\n  clientForSourceMap(sourceMap: SourceMap): T|undefined {\n    return this.#sourceMaps.get(sourceMap);\n  }\n\n  // TODO(bmeurer): We are lying about the type of |relativeSourceURL| here.\n  attachSourceMap(\n      client: T, relativeSourceURL: Platform.DevToolsPath.UrlString, relativeSourceMapURL: string|undefined): void {\n    if (this.#clientData.has(client)) {\n      throw new Error('SourceMap is already attached or being attached to client');\n    }\n    if (!relativeSourceMapURL) {\n      return;\n    }\n\n    let clientData: ClientData|null = {\n      relativeSourceURL,\n      relativeSourceMapURL,\n      sourceMap: undefined,\n      sourceMapPromise: Promise.resolve(undefined),\n    };\n    if (this.#isEnabled) {\n      // The `// #sourceURL=foo` can be a random string, but is generally an absolute path.\n      // Complete it to inspected page url for relative links.\n      const sourceURL = SourceMapManager.resolveRelativeSourceURL(this.#target, relativeSourceURL);\n      const sourceMapURL = Common.ParsedURL.ParsedURL.completeURL(sourceURL, relativeSourceMapURL);\n      if (sourceMapURL) {\n        if (this.#attachingClient) {\n          // This should not happen\n          console.error('Attaching source map may cancel previously attaching source map');\n        }\n        this.#attachingClient = client;\n        this.dispatchEventToListeners(Events.SourceMapWillAttach, {client});\n\n        if (this.#attachingClient === client) {\n          this.#attachingClient = null;\n          const initiator = client.createPageResourceLoadInitiator();\n          clientData.sourceMapPromise =\n              loadSourceMap(sourceMapURL, initiator)\n                  .then(\n                      payload => {\n                        const sourceMap = new SourceMap(sourceURL, sourceMapURL, payload);\n                        if (this.#clientData.get(client) === clientData) {\n                          clientData.sourceMap = sourceMap;\n                          this.#sourceMaps.set(sourceMap, client);\n                          this.dispatchEventToListeners(Events.SourceMapAttached, {client, sourceMap});\n                        }\n                        return sourceMap;\n                      },\n                      () => {\n                        if (this.#clientData.get(client) === clientData) {\n                          this.dispatchEventToListeners(Events.SourceMapFailedToAttach, {client});\n                        }\n                        return undefined;\n                      });\n        } else {\n          // Assume cancelAttachSourceMap was called.\n          if (this.#attachingClient) {\n            // This should not happen\n            console.error('Cancelling source map attach because another source map is attaching');\n          }\n          clientData = null;\n          this.dispatchEventToListeners(Events.SourceMapFailedToAttach, {client});\n        }\n      }\n    }\n    if (clientData) {\n      this.#clientData.set(client, clientData);\n    }\n  }\n\n  cancelAttachSourceMap(client: T): void {\n    if (client === this.#attachingClient) {\n      this.#attachingClient = null;\n    } else {\n      // This should not happen.\n      if (this.#attachingClient) {\n        console.error('cancel attach source map requested but a different source map was being attached');\n      } else {\n        console.error('cancel attach source map requested but no source map was being attached');\n      }\n    }\n  }\n\n  detachSourceMap(client: T): void {\n    const clientData = this.#clientData.get(client);\n    if (!clientData) {\n      return;\n    }\n    this.#clientData.delete(client);\n    if (!this.#isEnabled) {\n      return;\n    }\n    const {sourceMap} = clientData;\n    if (sourceMap) {\n      this.#sourceMaps.delete(sourceMap);\n      this.dispatchEventToListeners(Events.SourceMapDetached, {client, sourceMap});\n    } else {\n      this.dispatchEventToListeners(Events.SourceMapFailedToAttach, {client});\n    }\n  }\n\n  dispose(): void {\n    TargetManager.instance().removeEventListener(\n        TargetManagerEvents.InspectedURLChanged, this.inspectedURLChanged, this);\n  }\n}\n\nasync function loadSourceMap(\n    url: Platform.DevToolsPath.UrlString, initiator: PageResourceLoadInitiator): Promise<SourceMapV3> {\n  try {\n    const {content} = await PageResourceLoader.instance().loadResource(url, initiator);\n    return parseSourceMap(content);\n  } catch (cause) {\n    throw new Error(`Could not load content for ${url}: ${cause.message}`, {cause});\n  }\n}\n\ntype ClientData = {\n  relativeSourceURL: Platform.DevToolsPath.UrlString,\n  // Stores the raw sourceMappingURL as provided by V8. These are not guaranteed to\n  // be valid URLs and will be checked and resolved once `attachSourceMap` is called.\n  relativeSourceMapURL: string,\n  sourceMap: SourceMap|undefined,\n  sourceMapPromise: Promise<SourceMap|undefined>,\n};\n\nexport enum Events {\n  SourceMapWillAttach = 'SourceMapWillAttach',\n  SourceMapFailedToAttach = 'SourceMapFailedToAttach',\n  SourceMapAttached = 'SourceMapAttached',\n  SourceMapDetached = 'SourceMapDetached',\n}\n\nexport type EventTypes<T extends FrameAssociated> = {\n  [Events.SourceMapWillAttach]: {client: T},\n  [Events.SourceMapFailedToAttach]: {client: T},\n  [Events.SourceMapAttached]: {client: T, sourceMap: SourceMap},\n  [Events.SourceMapDetached]: {client: T, sourceMap: SourceMap},\n};\n"]}