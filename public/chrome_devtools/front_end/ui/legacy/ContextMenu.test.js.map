{"version":3,"file":"ContextMenu.test.js","sourceRoot":"","sources":["../../../../../../front_end/ui/legacy/ContextMenu.test.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2023 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Common from '../../core/common/common.js';\nimport * as Host from '../../core/host/host.js';\nimport {dispatchMouseUpEvent} from '../../testing/DOMHelpers.js';\nimport {describeWithEnvironment} from '../../testing/EnvironmentHelpers.js';\nimport * as VisualLogging from '../visual_logging/visual_logging.js';\n\nimport * as UI from './legacy.js';\n\nfunction getContextMenuElement(): HTMLElement {\n  const container = document.querySelector('div[data-devtools-glass-pane]');\n  const softMenuElement = container!.shadowRoot!.querySelector('.widget > .soft-context-menu');\n  assert.instanceOf(softMenuElement, HTMLElement);\n  return softMenuElement;\n}\n\ndescribeWithEnvironment('ContextMenu', () => {\n  let menuItems: UI.SoftContextMenu.SoftContextMenuDescriptor[];\n  beforeEach(() => {\n    menuItems = [\n      {\n        type: 'checkbox',\n        id: 0,\n        label: 'item0',\n        checked: false,\n      },\n      {\n        type: 'checkbox',\n        id: 1,\n        label: 'item1',\n        checked: false,\n      },\n    ];\n  });\n\n  it('stays open after clicking on an item when keepOpen is true', () => {\n    const softMenu = new UI.SoftContextMenu.SoftContextMenu(menuItems, () => {}, true);\n    const contextMenuDiscardSpy = sinon.spy(softMenu, 'discard');\n    softMenu.show(document, new AnchorBox(0, 0, 0, 0));\n    const softMenuElement = getContextMenuElement();\n\n    const item0 = softMenuElement.querySelector('[aria-label^=\"item0\"]');\n    assert.instanceOf(item0, HTMLElement);\n    const item1 = softMenuElement.querySelector('[aria-label^=\"item1\"]');\n    assert.instanceOf(item1, HTMLElement);\n\n    assert.isFalse(item0.hasAttribute('checked'));\n    assert.isFalse(item1.hasAttribute('checked'));\n\n    dispatchMouseUpEvent(item0);\n    dispatchMouseUpEvent(item1);\n    assert.isTrue(item0.hasAttribute('checked'));\n    assert.isTrue(item1.hasAttribute('checked'));\n    assert.isTrue(!contextMenuDiscardSpy.called);\n\n    dispatchMouseUpEvent(item0);\n    assert.isFalse(item0.hasAttribute('checked'));\n    assert.isTrue(item1.hasAttribute('checked'));\n    assert.isTrue(!contextMenuDiscardSpy.called);\n\n    softMenu.discard();\n  });\n\n  it('closes after clicking on an item when keepOpen is false', () => {\n    const softMenu = new UI.SoftContextMenu.SoftContextMenu(menuItems, () => {}, false);\n    const contextMenuDiscardSpy = sinon.spy(softMenu, 'discard');\n    softMenu.show(document, new AnchorBox(0, 0, 0, 0));\n    const softMenuElement = getContextMenuElement();\n\n    const item0 = softMenuElement.querySelector('[aria-label^=\"item0\"]');\n    assert.instanceOf(item0, HTMLElement);\n    dispatchMouseUpEvent(item0);\n    assert.isTrue(contextMenuDiscardSpy.called);\n\n    softMenu.discard();\n  });\n\n  it('uses hosted menu when possible', async () => {\n    sinon.stub(Host.InspectorFrontendHost.InspectorFrontendHostInstance, 'isHostedMode').returns(false);\n    const showContextMenuAtPoint =\n        sinon.stub(Host.InspectorFrontendHost.InspectorFrontendHostInstance, 'showContextMenuAtPoint');\n\n    const event = new Event('contextmenu');\n    sinon.stub(event, 'target').value(document);\n    const contextMenu = new UI.ContextMenu.ContextMenu(event);\n    await contextMenu.show();\n    assert.isTrue(showContextMenuAtPoint.called);\n  });\n\n  it('logs impressions and clicks for hosted menu', async () => {\n    const throttler = new Common.Throttler.Throttler(1000000000);\n    await VisualLogging.startLogging({processingThrottler: throttler});\n    sinon.stub(Host.InspectorFrontendHost.InspectorFrontendHostInstance, 'isHostedMode').returns(false);\n    sinon.stub(Host.InspectorFrontendHost.InspectorFrontendHostInstance, 'showContextMenuAtPoint');\n    const recordImpression = sinon.stub(\n        Host.InspectorFrontendHost.InspectorFrontendHostInstance,\n        'recordImpression',\n    );\n\n    const recordClick = sinon.stub(\n        Host.InspectorFrontendHost.InspectorFrontendHostInstance,\n        'recordClick',\n    );\n\n    const event = new Event('contextmenu');\n    sinon.stub(event, 'target').value(document);\n    const contextMenu = new UI.ContextMenu.ContextMenu(event);\n    contextMenu.defaultSection().appendItem('item 1', () => {}, {jslogContext: '42'});\n    contextMenu.defaultSection().appendItem('item 2', () => {}, {jslogContext: '44'});\n    await contextMenu.show();\n    await new Promise(resolve => setTimeout(resolve, 0));\n    assert.exists(throttler.process);\n    await throttler.process?.();\n    assert.isTrue(recordImpression.calledOnce);\n    const impressions =\n        recordImpression.firstCall.firstArg.impressions as Host.InspectorFrontendHostAPI.VisualElementImpression[];\n    const menuId = impressions.find(i => !i.parent)?.id;\n    assert.exists(menuId);\n    assert.sameDeepMembers(impressions.map(i => ({...i, id: 0})), [\n      {id: 0, type: 67, height: 0, width: 0},\n      {id: 0, type: 29, parent: menuId, context: 42, height: 0, width: 0},\n      {id: 0, type: 29, parent: menuId, context: 44, height: 0, width: 0},\n    ]);\n\n    Host.InspectorFrontendHost.InspectorFrontendHostInstance.events.dispatchEventToListeners(\n        Host.InspectorFrontendHostAPI.Events.ContextMenuItemSelected, 1);\n\n    await new Promise(resolve => setTimeout(resolve, 0));\n    assert.isTrue(recordClick.calledOnce);\n    VisualLogging.stopLogging();\n  });\n});\n"]}