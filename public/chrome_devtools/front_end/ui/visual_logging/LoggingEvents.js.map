{"version":3,"file":"LoggingEvents.js","sourceRoot":"","sources":["../../../../../../front_end/ui/visual_logging/LoggingEvents.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2023 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport type * as Common from '../../core/common/common.js';\nimport * as Host from '../../core/host/host.js';\nimport {assertNotNullOrUndefined} from '../../core/platform/platform.js';\n\nimport {processEventForDebugging, processImpressionsForDebugging} from './Debugging.js';\nimport {type Loggable} from './Loggable.js';\nimport {getLoggingState, type LoggingState} from './LoggingState.js';\n\nexport async function logImpressions(loggables: Loggable[]): Promise<void> {\n  const impressions = await Promise.all(loggables.map(async loggable => {\n    const loggingState = getLoggingState(loggable);\n    assertNotNullOrUndefined(loggingState);\n    const impression:\n        Host.InspectorFrontendHostAPI.VisualElementImpression = {id: loggingState.veid, type: loggingState.config.ve};\n    if (typeof loggingState.config.context !== 'undefined') {\n      impression.context = await contextAsNumber(loggingState.config.context);\n    }\n    if (loggingState.parent) {\n      impression.parent = loggingState.parent.veid;\n    }\n    if (loggingState.size) {\n      impression.width = Math.round(loggingState.size.width);\n      impression.height = Math.round(loggingState.size.height);\n    }\n    return impression;\n  }));\n  if (impressions.length) {\n    Host.InspectorFrontendHost.InspectorFrontendHostInstance.recordImpression({impressions});\n    processImpressionsForDebugging(loggables.map(l => getLoggingState(l) as LoggingState));\n  }\n}\n\nexport const logResize = (loggable: Loggable, size: DOMRect): void => {\n  const loggingState = getLoggingState(loggable);\n  if (!loggingState) {\n    return;\n  }\n  loggingState.size = size;\n  const resizeEvent: Host.InspectorFrontendHostAPI\n      .ResizeEvent = {veid: loggingState.veid, width: loggingState.size.width, height: loggingState.size.height};\n  Host.InspectorFrontendHost.InspectorFrontendHostInstance.recordResize(resizeEvent);\n  processEventForDebugging('Resize', loggingState, {width: Math.round(size.width), height: Math.round(size.height)});\n};\n\nexport const logClick = (throttler: Common.Throttler.Throttler) => (\n    loggable: Loggable, event: Event, options?: {doubleClick?: boolean}) => {\n  const loggingState = getLoggingState(loggable);\n  if (!loggingState) {\n    return;\n  }\n  const clickEvent:\n      Host.InspectorFrontendHostAPI.ClickEvent = {veid: loggingState.veid, doubleClick: Boolean(options?.doubleClick)};\n  if (event instanceof MouseEvent && 'sourceCapabilities' in event && event.sourceCapabilities) {\n    clickEvent.mouseButton = event.button;\n  }\n  void throttler.schedule(async () => {\n    Host.InspectorFrontendHost.InspectorFrontendHostInstance.recordClick(clickEvent);\n    processEventForDebugging(\n        'Click', loggingState, {mouseButton: clickEvent.mouseButton, doubleClick: clickEvent.doubleClick});\n  });\n};\n\nexport const logHover = (throttler: Common.Throttler.Throttler) => async (event: Event) => {\n  const loggingState = getLoggingState(event.currentTarget as Element);\n  assertNotNullOrUndefined(loggingState);\n  const hoverEvent: Host.InspectorFrontendHostAPI.HoverEvent = {veid: loggingState.veid};\n  await throttler.schedule(async () => {});  // Ensure the logging won't get scheduled immediately\n  void throttler.schedule(async () => {\n    Host.InspectorFrontendHost.InspectorFrontendHostInstance.recordHover(hoverEvent);\n    processEventForDebugging('Hover', loggingState);\n  });\n};\n\nexport const logDrag = (throttler: Common.Throttler.Throttler) => async (event: Event) => {\n  const loggingState = getLoggingState(event.currentTarget as Element);\n  assertNotNullOrUndefined(loggingState);\n  const dragEvent: Host.InspectorFrontendHostAPI.DragEvent = {veid: loggingState.veid};\n  await throttler.schedule(async () => {});  // Ensure the logging won't get scheduled immediately\n  void throttler.schedule(async () => {\n    Host.InspectorFrontendHost.InspectorFrontendHostInstance.recordDrag(dragEvent);\n    processEventForDebugging('Drag', loggingState);\n  });\n};\n\nexport async function logChange(loggable: Loggable): Promise<void> {\n  const loggingState = getLoggingState(loggable);\n  assertNotNullOrUndefined(loggingState);\n  const changeEvent: Host.InspectorFrontendHostAPI.ChangeEvent = {veid: loggingState.veid};\n  const context = loggingState.lastInputEventType;\n  if (context) {\n    changeEvent.context = await contextAsNumber(context);\n  }\n  Host.InspectorFrontendHost.InspectorFrontendHostInstance.recordChange(changeEvent);\n  processEventForDebugging('Change', loggingState, {context});\n}\n\nlet pendingKeyDownContext: string|null = null;\n\nexport const logKeyDown =\n    (throttler: Common.Throttler.Throttler) => async (loggable: Loggable|null, event: Event|null, context?: string) => {\n      if (!(event instanceof KeyboardEvent)) {\n        return;\n      }\n      const loggingState = loggable ? getLoggingState(loggable) : null;\n      const codes = (typeof loggingState?.config.track?.keydown === 'string') ? loggingState.config.track.keydown : '';\n      if (codes.length && !codes.split('|').includes(event.code) && !codes.split('|').includes(event.key)) {\n        return;\n      }\n      const keyDownEvent: Host.InspectorFrontendHostAPI.KeyDownEvent = {veid: loggingState?.veid};\n      if (!context && codes?.length) {\n        context = contextFromKeyCodes(event);\n      }\n      if (context) {\n        keyDownEvent.context = await contextAsNumber(context);\n      }\n\n      if (pendingKeyDownContext && context && pendingKeyDownContext !== context) {\n        void throttler.process?.();\n      }\n\n      pendingKeyDownContext = context || null;\n      void throttler.schedule(async () => {\n        Host.InspectorFrontendHost.InspectorFrontendHostInstance.recordKeyDown(keyDownEvent);\n        processEventForDebugging('KeyDown', loggingState, {context});\n        pendingKeyDownContext = null;\n      });\n    };\n\nfunction contextFromKeyCodes(event: Event): string|undefined {\n  if (!(event instanceof KeyboardEvent)) {\n    return undefined;\n  }\n  const key = event.key;\n  const lowerCaseKey = key.toLowerCase();\n  const components = [];\n  if (event.shiftKey && key !== lowerCaseKey) {\n    components.push('shift');\n  }\n  if (event.ctrlKey) {\n    components.push('ctrl');\n  }\n  if (event.altKey) {\n    components.push('alt');\n  }\n  if (event.metaKey) {\n    components.push('meta');\n  }\n  components.push(lowerCaseKey);\n  return components.join('-');\n}\n\nasync function contextAsNumber(context: string|undefined): Promise<number|undefined> {\n  if (typeof context === 'undefined') {\n    return undefined;\n  }\n  const number = parseInt(context, 10);\n  if (!isNaN(number)) {\n    return number;\n  }\n  if (!crypto.subtle) {\n    // Layout tests run in an insecure context where crypto.subtle is not available.\n    return 0xDEADBEEF;\n  }\n  const encoder = new TextEncoder();\n  const data = encoder.encode(context);\n  const digest = await crypto.subtle.digest('SHA-1', data);\n  return new DataView(digest).getInt32(0, true);\n}\n"]}