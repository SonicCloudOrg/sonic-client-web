{"version":3,"file":"DiffView.test.js","sourceRoot":"","sources":["../../../../../../../front_end/ui/components/diff_view/DiffView.test.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2020 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport {describeWithLocale} from '../../../testing/EnvironmentHelpers.js';\nimport * as Diff from '../../../third_party/diff/diff.js';\n\nimport * as DiffView from './diff_view.js';\n\nfunction buildDiff(original: string, updated: string): Promise<DocumentFragment> {\n  const diff = Diff.Diff.DiffWrapper.lineDiff(original.split('\\n'), updated.split('\\n'));\n  const view = new DiffView.DiffView.DiffView({diff, mimeType: 'text/javascript'});\n  return view.loaded.then(() => view.shadowRoot as DocumentFragment);\n}\n\nlet cachedSimpleDiff: Promise<DocumentFragment>|null = null;\n\nconst original = 'let x = `one\\ntwo` /* with a\\ncomment */\\nreturn okay()';\nconst updated = 'let x = `one\\nthree` // with a\\n\"comment\"\\nreturn okay()';\n\nfunction simpleDiff(): Promise<DocumentFragment> {\n  if (!cachedSimpleDiff) {\n    cachedSimpleDiff = buildDiff(original, updated);\n  }\n  return cachedSimpleDiff;\n}\n\nfunction text(elt: Node): string {\n  if (elt instanceof Text) {\n    return elt.nodeValue as string;\n  }\n  if (elt instanceof HTMLElement && !elt.classList.contains('diff-hidden-text')) {\n    return Array.from(elt.childNodes).map(text).join('');\n  }\n  return '';\n}\n\ndescribeWithLocale('DiffView', () => {\n  it('renders the proper content', async () => {\n    const output = await simpleDiff();\n    const lines = Array.from(output.querySelectorAll('.diff-line-content'));\n    assert.strictEqual(lines.length, 6);\n    assert.strictEqual(lines.filter(l => !l.classList.contains('diff-line-addition')).map(text).join('\\n'), original);\n    assert.strictEqual(lines.filter(l => !l.classList.contains('diff-line-deletion')).map(text).join('\\n'), updated);\n  });\n\n  it('renders line numbers', async () => {\n    const output = await simpleDiff();\n    const numbers = Array.from(output.querySelectorAll('.diff-line-number'));\n    // Line numbers are rendered pairwise per line, with one number\n    // omitted from inserted/deleted lines\n    assert.strictEqual(numbers.map(text).join('-'), '1-1-2--3---2--3-4-4');\n  });\n\n  it('highlights code properly', async () => {\n    const output = await simpleDiff();\n    const lines = output.querySelectorAll('.diff-line-content');\n    // Basic highlighting\n    assert.isNotNull(lines[0].querySelector('.token-keyword'));\n    // Accurate per-file highlighting\n    // - lines[2] holds 'comment */', lines[4] holds '\"comment\"'.\n    assert.isNotNull(lines[2].querySelector('.token-comment'));\n    assert.isNotNull(lines[4].querySelector('.token-string'));\n  });\n\n  it('collapses long stretches of equal text', async () => {\n    const original = 'boring\\n'.repeat(100);\n    const changed = 'interesting\\n' + original.slice(0, 500) + '...' + original.slice(500);\n    const view = await buildDiff(original, changed);\n    assert.isTrue(view.querySelectorAll('.diff-line-content').length < 100);\n    assert.isNotNull(view.querySelector('.diff-line-spacer'));\n  });\n});\n"]}